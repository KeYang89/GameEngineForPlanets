<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>genWorld ‚Äî Planet Generator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;800&display=swap');

:root {
  --bg: #070a0f;
  --panel: rgba(10,15,22,0.92);
  --border: rgba(80,160,255,0.18);
  --accent: #3a9fff;
  --accent2: #7b5fff;
  --hot: #ff6b35;
  --cold: #35d4ff;
  --green: #3fff8a;
  --text: #c8d8ee;
  --muted: rgba(180,210,255,0.45);
  --glow: 0 0 18px rgba(58,159,255,0.3);
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; background:var(--bg); font-family:'Space Mono',monospace; color:var(--text); overflow:hidden; }

/* ‚îÄ‚îÄ SCREEN STATES ‚îÄ‚îÄ */
#setup-screen, #world-screen {
  position:absolute; inset:0;
  transition: opacity 0.5s ease, transform 0.5s ease;
}
#world-screen {
  opacity:0; pointer-events:none; transform:scale(0.97);
}
body.playing #setup-screen {
  opacity:0; pointer-events:none; transform:scale(1.03);
}
body.playing #world-screen {
  opacity:1; pointer-events:all; transform:scale(1);
}

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
#setup-screen {
  display:flex; flex-direction:column; align-items:center; justify-content: flex-start;
  gap:0; overflow-y:auto;
  background: radial-gradient(ellipse at 30% 40%, rgba(58,159,255,0.07) 0%, transparent 60%),
              radial-gradient(ellipse at 70% 60%, rgba(123,95,255,0.07) 0%, transparent 60%),
              var(--bg);
}

/* Star field */
#setup-screen::before {
  content:'';
  position:fixed; inset:0;
  background-image:
    radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.5) 0%, transparent 100%),
    radial-gradient(1px 1px at 25% 40%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 50% 10%, rgba(255,255,255,0.6) 0%, transparent 100%),
    radial-gradient(1px 1px at 75% 25%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 88% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 15% 80%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1.5px 1.5px at 60% 85%, rgba(255,255,255,0.5) 0%, transparent 100%),
    radial-gradient(1px 1px at 92% 90%, rgba(255,255,255,0.3) 0%, transparent 100%);
  pointer-events:none;
}

.setup-inner {
  width:min(820px, 96vw);
  padding:40px 0 60px;
  display:flex; flex-direction:column; gap:32px;
}

.logo {
  text-align:center;
}
.logo h1 {
  font-family:'Syne',sans-serif;
  font-size:clamp(2.4rem,5vw,4rem);
  font-weight:800;
  letter-spacing:-0.02em;
  background: linear-gradient(135deg, #fff 20%, var(--accent) 60%, var(--accent2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  line-height:1;
}
.logo p {
  font-size:0.72rem;
  color:var(--muted);
  letter-spacing:4px;
  margin-top:8px;
  text-transform:uppercase;
}

/* Config panels */
.config-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.config-grid.full { grid-template-columns:1fr; }

.panel {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:22px 24px;
  display:flex; flex-direction:column; gap:16px;
}
.panel-title {
  font-family:'Syne',sans-serif;
  font-size:0.68rem;
  font-weight:600;
  letter-spacing:4px;
  text-transform:uppercase;
  color:var(--accent);
  padding-bottom:12px;
  border-bottom:1px solid var(--border);
}

/* Form elements */
.field {
  display:flex; flex-direction:column; gap:6px;
}
.field label {
  font-size:0.65rem;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--muted);
}
.field input[type="text"], .field select {
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  border-radius:7px;
  padding:9px 13px;
  font-family:'Space Mono',monospace;
  font-size:0.8rem;
  color:var(--text);
  outline:none;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.field input:focus, .field select:focus {
  border-color:rgba(58,159,255,0.6);
  box-shadow:var(--glow);
}
.field select option { background:#0d1520; }

/* Slider */
.slider-field {
  display:flex; flex-direction:column; gap:6px;
}
.slider-field label {
  font-size:0.65rem; letter-spacing:2px; text-transform:uppercase; color:var(--muted);
  display:flex; justify-content:space-between;
}
.slider-field label span { color:var(--accent); font-weight:700; }
input[type="range"] {
  -webkit-appearance:none; width:100%; height:4px;
  background:rgba(58,159,255,0.2); border-radius:2px; outline:none; cursor:pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance:none; width:16px; height:16px;
  background:var(--accent); border-radius:50%;
  box-shadow:0 0 8px var(--accent);
  transition:transform 0.15s;
}
input[type="range"]::-webkit-slider-thumb:hover { transform:scale(1.3); }

/* Civ rows */
.civ-config {
  display:flex; flex-direction:column; gap:10px;
}
.civ-row {
  display:grid;
  grid-template-columns:auto 1fr auto auto auto;
  gap:8px; align-items:center;
}
.civ-number {
  font-size:0.65rem; color:var(--muted);
  width:16px; text-align:right;
}
.civ-row input[type="text"] {
  background:rgba(255,255,255,0.04);
  border:1px solid var(--border);
  border-radius:6px;
  padding:6px 10px;
  font-family:'Space Mono',monospace;
  font-size:0.75rem;
  color:var(--text);
  outline:none;
  min-width:0;
  transition:border-color 0.2s;
}
.civ-row input[type="text"]:focus { border-color:rgba(58,159,255,0.6); }
.civ-color {
  width:30px; height:30px; border-radius:6px; cursor:pointer;
  border:2px solid rgba(255,255,255,0.15);
  padding:0;
  background:none;
  overflow:hidden;
}
.trait-badge {
  font-size:0.6rem; letter-spacing:1px; text-transform:uppercase;
  padding:3px 7px; border-radius:4px;
  background:rgba(58,159,255,0.12);
  color:var(--accent);
  border:1px solid rgba(58,159,255,0.25);
  cursor:pointer;
  white-space:nowrap;
  user-select:none;
  transition:all 0.15s;
}
.trait-badge:hover { background:rgba(58,159,255,0.25); }
.remove-civ {
  width:20px; height:20px;
  background:rgba(255,80,80,0.1);
  border:1px solid rgba(255,80,80,0.25);
  border-radius:4px; cursor:pointer;
  color:rgba(255,100,100,0.7); font-size:0.7rem;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s;
}
.remove-civ:hover { background:rgba(255,80,80,0.25); color:#ff6060; }

.add-civ-btn {
  width:100%;
  padding:8px;
  background:rgba(58,159,255,0.06);
  border:1px dashed rgba(58,159,255,0.25);
  border-radius:7px;
  cursor:pointer; color:var(--muted);
  font-family:'Space Mono',monospace;
  font-size:0.7rem; letter-spacing:2px; text-transform:uppercase;
  transition:all 0.2s;
}
.add-civ-btn:hover { background:rgba(58,159,255,0.12); color:var(--accent); border-color:rgba(58,159,255,0.45); }

/* Color chips for biome/atmo */
.chip-row {
  display:flex; flex-wrap:wrap; gap:8px;
}
.chip {
  padding:5px 12px; border-radius:20px; cursor:pointer;
  font-size:0.65rem; letter-spacing:1px; text-transform:uppercase;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.04);
  color:var(--muted);
  transition:all 0.18s; user-select:none;
}
.chip:hover { border-color:rgba(58,159,255,0.4); color:var(--text); }
.chip.active {
  background:rgba(58,159,255,0.18);
  border-color:var(--accent);
  color:#fff;
  box-shadow:0 0 10px rgba(58,159,255,0.2);
}

/* Generate button */
.generate-btn {
  width:100%; padding:16px;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  border:none; border-radius:10px; cursor:pointer;
  font-family:'Syne',sans-serif; font-size:1rem; font-weight:800;
  letter-spacing:3px; text-transform:uppercase;
  color:#fff;
  box-shadow: 0 0 30px rgba(58,159,255,0.3), 0 4px 20px rgba(0,0,0,0.4);
  transition:all 0.25s;
  position:relative; overflow:hidden;
}
.generate-btn::after {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
}
.generate-btn:hover { transform:translateY(-2px); box-shadow:0 0 40px rgba(58,159,255,0.5), 0 8px 30px rgba(0,0,0,0.4); }
.generate-btn:active { transform:translateY(0); }

/* ‚îÄ‚îÄ WORLD SCREEN ‚îÄ‚îÄ */
#world-screen {
  display:flex; flex-direction:column;
}

#world-canvas-wrap {
  flex:1; position:relative; overflow:hidden;
}

#world-svg {
  width:100%; height:100%; display:block;
}

/* HUD panels */
.hud {
  position:absolute; pointer-events:none;
  background:rgba(7,10,15,0.88);
  border:1px solid var(--border);
  border-radius:10px;
  backdrop-filter:blur(8px);
  padding:14px 18px;
}
#hud-top-left {
  top:14px; left:14px; min-width:200px;
}
#hud-top-right {
  top:14px; right:14px; width:240px;
}
#hud-bottom {
  bottom:14px; left:14px; right:14px;
  display:flex; gap:10px; align-items:flex-end;
  background:none; border:none; backdrop-filter:none; padding:0;
  pointer-events:all;
}

.hud-title {
  font-family:'Syne',sans-serif;
  font-size:0.65rem; font-weight:800;
  letter-spacing:4px; text-transform:uppercase;
  color:var(--accent);
  padding-bottom:9px;
  margin-bottom:9px;
  border-bottom:1px solid var(--border);
}
.stat-row {
  display:flex; justify-content:space-between;
  font-size:0.65rem; color:var(--muted);
  margin:3px 0; letter-spacing:0.5px;
}
.stat-val { color:#fff; font-weight:700; }

#event-log {
  flex:1;
  background:rgba(7,10,15,0.88);
  border:1px solid var(--border);
  border-radius:10px;
  backdrop-filter:blur(8px);
  padding:14px 18px;
  max-height:130px; overflow:hidden;
}
.event-entry {
  font-size:0.6rem; line-height:1.6;
  color:var(--muted);
  border-bottom:1px solid rgba(255,255,255,0.04);
  padding:3px 0;
}
.event-entry.war { color:#ff6b6b; }
.event-entry.peace { color:var(--green); }
.event-entry.culture { color:#c79fff; }
.event-entry.wonder { color:#ffd166; }

#year-display {
  position:absolute; top:14px; left:50%;
  transform:translateX(-50%);
  font-family:'Syne',sans-serif;
  font-size:0.7rem; font-weight:800;
  letter-spacing:5px; text-transform:uppercase;
  color:var(--muted);
  pointer-events:none;
}
#year-display span { color:#fff; }

.civ-legend {
  background:rgba(7,10,15,0.88);
  border:1px solid var(--border);
  border-radius:10px;
  backdrop-filter:blur(8px);
  padding:14px 18px;
  min-width:180px;
}
.civ-legend-title {
  font-family:'Syne',sans-serif;
  font-size:0.6rem; font-weight:800;
  letter-spacing:3px; text-transform:uppercase;
  color:var(--muted); margin-bottom:9px;
}
.legend-row {
  display:flex; align-items:center; gap:9px;
  font-size:0.65rem; color:var(--muted);
  margin:5px 0;
}
.legend-dot {
  width:9px; height:9px; border-radius:50%; flex-shrink:0;
}
.legend-pop { margin-left:auto; font-size:0.6rem; color:var(--accent); }

.btn-share {
  padding:8px 18px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:7px; cursor:pointer;
  font-family:'Space Mono',monospace;
  font-size:0.65rem; letter-spacing:2px; text-transform:uppercase;
  color:var(--muted); pointer-events:all;
}

.btn-bottom {
  position:absolute; bottom:14px; 
  padding:8px 18px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:7px; cursor:pointer;
  font-family:'Space Mono',monospace;
  font-size:0.65rem; letter-spacing:2px; text-transform:uppercase;
  color:var(--muted); pointer-events:all;
  transition:all 0.2s;
}
.btn-bottom:hover { background:rgba(255,255,255,0.1); color:#fff; }

#share-btn {
  right: 160px;
}
#back-btn {
  right:14px;
}
#tooltip {
  position:absolute; display:none;
  background:rgba(7,10,15,0.95);
  border:1px solid var(--border);
  border-radius:9px;
  padding:12px 16px;
  pointer-events:none;
  z-index:999;
  max-width:220px;
  backdrop-filter:blur(8px);
}
#tooltip h3 {
  font-family:'Syne',sans-serif;
  font-size:0.75rem; font-weight:800;
  color:#fff; margin-bottom:7px;
}
#tooltip p {
  font-size:0.62rem; color:var(--muted); line-height:1.6;
}

/* ‚îÄ‚îÄ CREATURE INTERACTION PANEL ‚îÄ‚îÄ */
#creature-panel {
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  z-index:500;
  pointer-events:none;
  opacity:0;
  transition:opacity 0.3s ease;
}
#creature-panel.visible {
  pointer-events:all;
  opacity:1;
}
#creature-backdrop {
  position:absolute; inset:0;
  background:rgba(0,0,0,0.65);
  backdrop-filter:blur(3px);
}
#creature-card {
  position:relative; z-index:1;
  background:rgba(7,12,20,0.97);
  border:1px solid var(--border);
  border-radius:16px;
  width:min(780px, 95vw);
  max-height:85vh;
  overflow:hidden;
  display:flex; flex-direction:column;
  box-shadow:0 0 60px rgba(58,159,255,0.15), 0 20px 60px rgba(0,0,0,0.6);
}
#creature-card-header {
  padding:18px 22px 14px;
  border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:flex-start;
  flex-shrink:0;
}
#creature-header-text h2 {
  font-family:'Syne',sans-serif; font-size:0.85rem; font-weight:800;
  letter-spacing:3px; text-transform:uppercase; color:#fff;
}
#creature-header-text p {
  font-size:0.62rem; color:var(--muted); margin-top:3px; letter-spacing:1px;
}
#close-creature-panel {
  width:28px; height:28px; border-radius:7px;
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.12);
  color:var(--muted); font-size:0.9rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.15s; flex-shrink:0;
}
#close-creature-panel:hover { background:rgba(255,80,80,0.2); color:#ff6060; border-color:rgba(255,80,80,0.3); }

/* Creature scene canvas */
#creature-scene {
  height:190px; position:relative; flex-shrink:0;
  border-bottom:1px solid var(--border);
  overflow:hidden;
}
#creature-scene-svg { width:100%; height:100%; display:block; }

/* Creature interaction log */
#creature-log {
  padding:14px 22px;
  overflow-y:auto;
  flex:1;
  min-height:100px;
  max-height:180px;
}
.interaction-entry {
  display:flex; gap:10px; align-items:flex-start;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,0.04);
  animation:fadeSlideIn 0.3s ease;
}
@keyframes fadeSlideIn {
  from { opacity:0; transform:translateY(-5px); }
  to   { opacity:1; transform:translateY(0); }
}
.interaction-entry:last-child { border-bottom:none; }
.ie-emoji { font-size:1.2rem; flex-shrink:0; width:26px; text-align:center; margin-top:1px; }
.ie-text  { font-size:0.65rem; color:var(--text); line-height:1.6; }
.ie-text strong { color:#fff; }
.ie-time  { color:var(--muted); font-size:0.57rem; margin-left:6px; }

/* Creature roster strip */
#creature-roster {
  display:flex; gap:7px; padding:12px 22px;
  border-top:1px solid var(--border);
  flex-wrap:wrap;
  background:rgba(0,0,0,0.2);
  flex-shrink:0;
}
.creature-chip {
  display:flex; align-items:center; gap:6px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.09);
  border-radius:8px;
  padding:5px 10px;
  cursor:pointer;
  transition:all 0.18s;
  user-select:none;
  position:relative;
}
.creature-chip:hover { background:rgba(58,159,255,0.12); border-color:rgba(58,159,255,0.35); }
.creature-chip.selected { background:rgba(58,159,255,0.2); border-color:var(--accent); box-shadow:0 0 8px rgba(58,159,255,0.2); }
.creature-chip .cc-emoji { font-size:1rem; }
.creature-chip .cc-name  { font-size:0.58rem; letter-spacing:1px; text-transform:uppercase; color:var(--muted); }
.creature-chip .cc-count {
  position:absolute; top:-5px; right:-5px;
  background:var(--accent2); color:#fff;
  font-size:0.5rem; font-weight:700;
  width:14px; height:14px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
}

/* Action buttons */
#creature-actions {
  display:flex; gap:7px; padding:12px 22px;
  border-top:1px solid var(--border);
  flex-shrink:0; flex-wrap:wrap;
}
.action-btn {
  flex:1; min-width:80px; padding:7px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px; cursor:pointer;
  font-family:'Space Mono',monospace;
  font-size:0.58rem; letter-spacing:1px; text-transform:uppercase;
  color:var(--muted);
  transition:all 0.18s;
  white-space:nowrap;
}
.action-btn:hover { background:rgba(58,159,255,0.12); border-color:rgba(58,159,255,0.35); color:var(--accent); }
.action-btn.danger:hover { background:rgba(255,80,80,0.12); border-color:rgba(255,80,80,0.35); color:#ff8080; }
.action-btn.golden:hover { background:rgba(255,209,102,0.12); border-color:rgba(255,209,102,0.35); color:#ffd166; }
.action-btn.peace:hover  { background:rgba(63,255,138,0.12); border-color:rgba(63,255,138,0.35); color:#3fff8a; }

/* Hint text on continents */
.continent-click-hint {
  font-size:7px; fill:rgba(255,255,255,0.3); text-anchor:middle;
  font-family:'Space Mono',monospace; letter-spacing:1px;
  pointer-events:none;
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SETUP SCREEN                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setup-screen">
<div class="setup-inner">

  <div class="logo">
    <h1>genWorld</h1>
    <p>Procedural Civilization Generator</p>
  </div>

  <!-- Row 1: Planet basics -->
  <div class="config-grid">
    <div class="panel">
      <div class="panel-title">Planet Identity</div>
      <div class="field">
        <label>Planet Name</label>
        <input type="text" id="planet-name" placeholder="e.g. Keth'ara" maxlength="24" value="">
      </div>
      <div class="field">
      <label>Ecosystem Mode</label>
      <div class="chip-row" id="ecosystem-toggle">
        <div class="chip" data-mode="earth">Earth-Like</div>
        <div class="chip active" data-mode="cosmic">Cosmic</div>
      </div>
    </div>
      <div class="field">
        <label>Dominant Biome</label>
        <select id="biome-select">
          <option value="temperate">Temperate ‚Äî Forests & Plains</option>
          <option value="desert">Desert ‚Äî Arid Wastes</option>
          <option value="ocean">Ocean World ‚Äî Vast Seas</option>
          <option value="jungle">Jungle ‚Äî Dense Canopy</option>
          <option value="arctic">Arctic ‚Äî Ice & Tundra</option>
          <option value="volcanic">Volcanic ‚Äî Fire & Ash</option>
          <option value="crystal">Crystal ‚Äî Mineral Formations</option>
          <option value="void">Void ‚Äî Dark Matter Fields</option>
        </select>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Atmosphere</div>
      <div class="slider-field">
        <label>Landmass Coverage <span id="land-val">55</span>%</label>
        <input type="range" id="land-slider" min="10" max="90" value="55">
      </div>
      <div class="slider-field">
        <label>Starting Year <span id="year-val">1</span></label>
        <input type="range" id="year-slider" min="1" max="500" value="1">
      </div>
      <div class="slider-field">
        <label>Sim Speed <span id="speed-val">1√ó</span></label>
        <input type="range" id="speed-slider" min="1" max="5" value="2">
      </div>
    </div>
  </div>

  <!-- Row 2: Civilization editor -->
  <div class="panel">
    <div class="panel-title">Civilizations</div>
    <div class="civ-config" id="civ-list"></div>
    <button class="add-civ-btn" id="add-civ-btn">+ Add Civilization</button>
  </div>

  <!-- Row 3: World traits -->
  <div class="config-grid">
    <div class="panel">
      <div class="panel-title">World Traits</div>
      <div class="chip-row" id="world-traits">
        <div class="chip active" data-trait="rivers">Rivers</div>
        <div class="chip active" data-trait="trade">Trade Routes</div>
        <div class="chip" data-trait="wonders">Wonders</div>
        <div class="chip" data-trait="plagues">Plagues</div>
        <div class="chip active" data-trait="wars">Wars</div>
        <div class="chip" data-trait="alliances">Alliances</div>
        <div class="chip" data-trait="golden-age">Golden Ages</div>
        <div class="chip" data-trait="cataclysm">Cataclysms</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Starting Conditions</div>
      <div class="chip-row" id="start-conditions">
        <div class="chip active" data-cond="cities">Major Cities</div>
        <div class="chip" data-cond="neutral">Neutral Start</div>
        <div class="chip" data-cond="hostile">Hostile World</div>
        <div class="chip" data-cond="advanced">Advanced Tech</div>
        <div class="chip" data-cond="sparse">Sparse Pop.</div>
      </div>
    </div>
  </div>

  <!-- Generate -->
  <button class="generate-btn" id="generate-btn">‚ü≥ Generate Planet</button>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  WORLD SCREEN                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="world-screen">
  <div id="world-canvas-wrap">
    <svg id="world-svg" xmlns="http://www.w3.org/2000/svg"></svg>

    <div class="hud" id="hud-top-left">
      <div class="hud-title" id="hud-planet-name">PLANET</div>
      <div class="stat-row"><span>Age</span><span class="stat-val" id="s-age">‚Äî</span></div>
      <div class="stat-row"><span>Year</span><span class="stat-val" id="s-year">‚Äî</span></div>
      <div class="stat-row"><span>World Pop.</span><span class="stat-val" id="s-pop">‚Äî</span></div>
      <div class="stat-row"><span>Active Wars</span><span class="stat-val" id="s-wars">‚Äî</span></div>
      <div class="stat-row"><span>Trade Routes</span><span class="stat-val" id="s-trade">‚Äî</span></div>
      <div class="stat-row"><span>Cities</span><span class="stat-val" id="s-cities">‚Äî</span></div>
    </div>

    <div id="year-display">YEAR <span id="year-counter">1</span></div>

    <div class="hud" id="hud-top-right">
      <div class="hud-title">Civilizations</div>
      <div id="civ-legend-rows"></div>
    </div>

    <div id="hud-bottom">
      <div id="event-log">
        <div class="hud-title" style="border:none;padding:0;margin-bottom:8px;">World Chronicle</div>
        <div id="events-container"></div>
      </div>
    </div>

    <div id="tooltip"><h3 id="tt-name"></h3><p id="tt-body"></p></div>
    <button class="btn-bottom" id="share-btn" onclick="captureAndShare()">
          üì∏ Capture World
    </button>
    <button class="btn-bottom" id="back-btn">‚Üê New Planet</button>

    <!-- ‚îÄ‚îÄ CREATURE INTERACTION PANEL ‚îÄ‚îÄ -->
    <div id="creature-panel">
      <div id="creature-backdrop"></div>
      <div id="creature-card">
        <div id="creature-card-header">
          <div id="creature-header-text">
            <h2 id="cp-continent-name">Island Ecosystem</h2>
            <p id="cp-subtitle">Click a creature to focus ¬∑ Watch interactions unfold</p>
          </div>
          <button id="close-creature-panel">‚úï</button>
        </div>
        <div id="creature-scene">
          <svg id="creature-scene-svg" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
        <div id="creature-log">
          <div id="interaction-entries"></div>
        </div>
        <div id="creature-roster"></div>
        <div id="creature-actions">
          <button class="action-btn" id="btn-feed">‚Üë Feed All</button>
          <button class="action-btn peace" id="btn-migrate">‚Üí Trigger Migration</button>
          <button class="action-btn golden" id="btn-breed">‚óé Mating Season</button>
          <button class="action-btn danger" id="btn-predator">‚úï Apex Arrives</button>
          <button class="action-btn" id="btn-disaster">~ Disaster</button>
        </div>
        <button class="btn-share" onclick="exportCreaturePNG()">
          üì∏ Capture World
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETUP LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TRAITS_POOL = [
  { name:'Aggressive', emoji:'‚öî', color:'#ff6b6b' },
  { name:'Maritime', emoji:'‚öì', color:'#35d4ff' },
  { name:'Arcane', emoji:'‚ú¶', color:'#c79fff' },
  { name:'Naturalist', emoji:'üåø', color:'#3fff8a' },
  { name:'Nomadic', emoji:'üèá', color:'#ffb347' },
  { name:'Merchant', emoji:'üí∞', color:'#ffd166' },
  { name:'Scholar', emoji:'üìú', color:'#a8d8ea' },
  { name:'Theocratic', emoji:'üïç', color:'#e8a0bf' },
];

const PRESET_NAMES = [
  'Kelthara','Vornex','Aethis','Zura','Nexvald','Sythe','Orrath','Lumineth','Drakonis','Quelaris'
];

const PRESET_CIV_NAMES = [
  ['Sunborn Empire','Tideclaw League','Verdant Clans','Obsidian Dominion','Ashborn Horde'],
  ['Iron Hegemony','Azure Republic','Forest Conclave','Shadow Court','Wanderers of Dust'],
  ['Solari Pact','Stormwave Union','Deep Rooters','Void Syndicate','Flame Nomads'],
  ['Aurumite Order','Sea Marauders','Green Council','Night Cabal','Sand Riders'],
];

let civs = [];
let nextCivId = 1;
const traitCycle = {};  // civId -> traitIndex

function randomColor() {
  const palette = ['#e74c3c','#2e86c1','#27ae60','#8e44ad','#d35400','#16a085','#f39c12','#c0392b','#1abc9c','#9b59b6'];
  return palette[Math.floor(Math.random() * palette.length)];
}

function addCiv(nameOverride, colorOverride, traitOverride) {
  if (civs.length >= 8) return;
  const id = nextCivId++;
  const preset = PRESET_CIV_NAMES[Math.floor(Math.random() * PRESET_CIV_NAMES.length)];
  
  // Ensure name is string
  let name = nameOverride || preset[Math.floor(Math.random() * preset.length)];
  if (typeof name !== 'string') name = 'New Civ';

  const color = colorOverride || randomColor();
  const traitIdx = Math.floor(Math.random() * TRAITS_POOL.length);
  traitCycle[id] = traitOverride !== undefined ? traitOverride : traitIdx;
  civs.push({ id, name, color });
  renderCivList();
}

function removeCiv(id) {
  if (civs.length <= 2) return;
  civs = civs.filter(c => c.id !== id);
  renderCivList();
}

function cycleTrait(id) {
  traitCycle[id] = (traitCycle[id] + 1) % TRAITS_POOL.length;
  renderCivList();
}

function renderCivList() {
  const container = document.getElementById('civ-list');
  container.innerHTML = '';
  civs.forEach((c, i) => {
    const trait = TRAITS_POOL[traitCycle[c.id] ?? 0];
    const row = document.createElement('div');
    row.className = 'civ-row';
    row.innerHTML = `
      <span class="civ-number">${i+1}</span>
      <input type="text" value="${c.name}" data-id="${c.id}" class="civ-name-input" placeholder="Civilization name">
      <input type="color" class="civ-color" value="${c.color}" data-id="${c.id}">
      <div class="trait-badge" data-id="${c.id}" style="color:${trait.color};border-color:${trait.color}30;background:${trait.color}18">${trait.emoji} ${trait.name}</div>
      <div class="remove-civ" data-id="${c.id}">‚úï</div>
    `;
    container.appendChild(row);
  });

  // Wire events
  container.querySelectorAll('.civ-name-input').forEach(inp => {
    inp.addEventListener('input', () => {
      const civ = civs.find(c => c.id == inp.dataset.id);
      if (civ) civ.name = inp.value;
    });
  });
  container.querySelectorAll('.civ-color').forEach(inp => {
    inp.addEventListener('input', () => {
      const civ = civs.find(c => c.id == inp.dataset.id);
      if (civ) civ.color = inp.value;
    });
  });
  container.querySelectorAll('.trait-badge').forEach(el => {
    el.addEventListener('click', () => cycleTrait(Number(el.dataset.id)));
  });
  container.querySelectorAll('.remove-civ').forEach(el => {
    el.addEventListener('click', () => removeCiv(Number(el.dataset.id)));
  });

  document.getElementById('add-civ-btn').style.opacity = civs.length >= 8 ? '0.3' : '1';
}

// Slider readouts
const sliders = [
  { id:'land-slider', out:'land-val', fmt: v => v + '%' },
  { id:'year-slider', out:'year-val', fmt: v => v },
  { id:'speed-slider', out:'speed-val', fmt: v => v + '√ó' },
];
sliders.forEach(({ id, out, fmt }) => {
  const el = document.getElementById(id);
  const o = document.getElementById(out);
  el.addEventListener('input', () => { o.textContent = fmt(el.value); });
});

// Chips
document.querySelectorAll('.chip').forEach(chip => {
  chip.addEventListener('click', () => chip.classList.toggle('active'));
});

document.getElementById('add-civ-btn').addEventListener('click', () => addCiv());

// Planet name random suggestion
const nameInput = document.getElementById('planet-name');
nameInput.placeholder = PRESET_NAMES[Math.floor(Math.random() * PRESET_NAMES.length)];

// Init with default civs
addCiv('Solari Empire', '#e85d4a');
addCiv('Thalassian League', '#2e86c1');
addCiv('Verdant Clans', '#3aaf6a');
addCiv('Obsidian Dominion', '#8e44ad');


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORLD GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let simInterval = null;
let worldConfig = null;
let worldState  = null;

document.getElementById('generate-btn').addEventListener('click', () => {
  // Check the active ecosystem chip
  const ecoChip = document.querySelector('#ecosystem-toggle .chip.active');
  const ecoMode = ecoChip.dataset.mode || 'cosmic';

  // Existing capture logic...
  const name = document.getElementById('planet-name').value.trim() || nameInput.placeholder;
  const biome = document.getElementById('biome-select').value;

  const landCoverage = Number(document.getElementById('land-slider').value) / 100;
  const startYear = Number(document.getElementById('year-slider').value);
  const simSpeed = Number(document.getElementById('speed-slider').value);

  const traits = {};
  document.querySelectorAll('#world-traits .chip').forEach(c => {
    traits[c.dataset.trait] = c.classList.contains('active');
  });
  const conditions = {};
  document.querySelectorAll('#start-conditions .chip').forEach(c => {
    conditions[c.dataset.cond] = c.classList.contains('active');
  });

  const civData = civs.map(c => ({
    ...c,
    trait: TRAITS_POOL[traitCycle[c.id] ?? 0],
  }));

  worldConfig = { name, biome, landCoverage, startYear, simSpeed, traits, conditions, civData, ecoMode };

  buildWorld(worldConfig);
  document.body.classList.add('playing');
});

document.getElementById('back-btn').addEventListener('click', () => {
  if (simInterval) clearInterval(simInterval);
  document.body.classList.remove('playing');
});

// ‚îÄ‚îÄ BIOME PALETTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BIOME_PALETTES = {
  temperate: { space:'#030a04', ocean:['#0a2e1c','#0f4526','#05180c'],
    land:['#3d7a3a','#5a9a50','#2d5a2a'], mountain:'#6a7060',
    river:'rgba(40,120,80,0.6)', sky:'#0a1a0d' },
  desert:    { space:'#0f0805', ocean:['#1a1a0a','#2a2a0e','#0a0a05'],
    land:['#c8a55a','#b8923e','#e8c070'], mountain:'#a06030',
    river:'rgba(180,140,60,0.5)', sky:'#1a0e05' },
  ocean:     { space:'#020510', ocean:['#062242','#0a3060','#041530'],
    land:['#2a5a3a','#3a7a4a','#1a4a2a'], mountain:'#3a5060',
    river:'rgba(30,100,180,0.7)', sky:'#030d1a' },
  jungle:    { space:'#020805', ocean:['#0a2015','#122a1a','#060f0a'],
    land:['#1a6030','#2a8040','#0a4020'], mountain:'#2a5030',
    river:'rgba(20,80,40,0.6)', sky:'#030d05' },
  arctic:    { space:'#020810', ocean:['#0a1530','#121a3a','#060c20'],
    land:['#cce8f4','#a0c8e0','#e8f4fc'], mountain:'#8a9ab0',
    river:'rgba(150,200,240,0.5)', sky:'#080f1a' },
  volcanic:  { space:'#0a0302', ocean:['#0a0500','#150800','#050200'],
    land:['#2a1010','#3d2020','#1a0808'], mountain:'#6a3020',
    river:'rgba(180,60,20,0.7)', sky:'#100502' },
  crystal:   { space:'#050510', ocean:['#0a0a20','#15153a','#050510'],
    land:['#4a3a8a','#6a5ab0','#2a2060'], mountain:'#7a6aa0',
    river:'rgba(100,80,200,0.6)', sky:'#08080f' },
  void:      { space:'#000000', ocean:['#030306','#06060d','#010103'],
    land:['#1a0a2a','#2a1040','#0d0520'], mountain:'#2a2040',
    river:'rgba(80,20,120,0.6)', sky:'#030105' },
};

const AGES = ['Dawn Age','Stone Age','Bronze Age','Iron Age','Classical Age',
              'Medieval Age','Renaissance','Industrial Age','Enlightened Age'];

function rand(a, b) { return a + Math.random() * (b - a); }
function randInt(a, b) { return Math.floor(rand(a, b + 1)); }
function lerp(a, b, t) { return a + (b - a) * t; }
function dist(x1,y1,x2,y2) { return Math.hypot(x2-x1,y2-y1); }

function el(tag, attrs = {}, parent = null) {
  const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs)) e.setAttribute(k, v);
  if (parent) parent.appendChild(e);
  return e;
}

function buildWorld(cfg) {
  if (simInterval) clearInterval(simInterval);

  const svg = document.getElementById('world-svg');
  svg.innerHTML = '';
  const W = svg.clientWidth || window.innerWidth;
  const H = svg.clientHeight || window.innerHeight;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  const pal = BIOME_PALETTES[cfg.biome] || BIOME_PALETTES.temperate;

  // ‚îÄ‚îÄ DEFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const defs = el('defs'); svg.appendChild(defs);

  function mkGlow(id, blur) {
    const f = el('filter', { id, x:'-60%', y:'-60%', width:'220%', height:'220%' }, defs);
    el('feGaussianBlur', { stdDeviation:blur, result:'b' }, f);
    const m = el('feMerge', {}, f);
    el('feMergeNode', { in:'b' }, m);
    el('feMergeNode', { in:'SourceGraphic' }, m);
  }
  mkGlow('g2', 2); mkGlow('g4', 4); mkGlow('g8', 8); mkGlow('g12', 12);

  const softF = el('filter', { id:'soft', x:'-50%', y:'-50%', width:'200%', height:'200%' }, defs);
  el('feGaussianBlur', { stdDeviation:'14' }, softF);

  // ‚îÄ‚îÄ LAYERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const layers = {};
  ['bg','ocean','terrain','rivers','territory','borders','trade','structures','units','fx','ui-svg'].forEach(n => {
    const g = el('g', { id: n }); svg.appendChild(g); layers[n] = g;
  });

  // ‚îÄ‚îÄ SPACE BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const bgG = el('radialGradient', { id:'space-bg', cx:'50%', cy:'50%', r:'70%' }, defs);
  el('stop', { offset:'0%', 'stop-color': pal.sky || '#050510' }, bgG);
  el('stop', { offset:'100%', 'stop-color': pal.space }, bgG);
  el('rect', { x:0, y:0, width:W, height:H, fill:'url(#space-bg)' }, layers['bg']);

  // Stars
  const starCount = cfg.biome === 'void' ? 300 : 120;
  for (let i = 0; i < starCount; i++) {
    el('circle', {
      cx: rand(0, W), cy: rand(0, H), r: rand(0.3, 1.4),
      fill: `hsl(${rand(200,260)},${rand(20,60)}%,${rand(70,95)}%)`,
      opacity: rand(0.15, 0.6)
    }, layers['bg']);
  }

  // ‚îÄ‚îÄ OCEAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const oceanG = el('radialGradient', { id:'ocean-base', cx:'45%', cy:'40%', r:'65%' }, defs);
  el('stop', { offset:'0%', 'stop-color': pal.ocean[1] }, oceanG);
  el('stop', { offset:'60%', 'stop-color': pal.ocean[0] }, oceanG);
  el('stop', { offset:'100%', 'stop-color': pal.ocean[2] }, oceanG);
  el('rect', { x:0, y:0, width:W, height:H, fill:'url(#ocean-base)' }, layers['ocean']);

  // Ocean shimmer
  for (let i = 0; i < 20; i++) {
    el('ellipse', {
      cx: rand(0, W), cy: rand(0, H),
      rx: rand(40, 200), ry: rand(15, 50),
      fill: `rgba(80,180,255,0.04)`,
      transform: `rotate(${rand(0,180)},${rand(0,W)},${rand(0,H)})`
    }, layers['ocean']);
  }

  // ‚îÄ‚îÄ PROCEDURAL CONTINENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const numContinents = Math.max(cfg.civData.length, Math.round(2 + cfg.landCoverage * 6));
  const continents = generateContinents(W, H, numContinents, cfg.landCoverage, pal, defs, layers);

  // ‚îÄ‚îÄ RIVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (cfg.traits.rivers) {
    generateRivers(W, H, continents, pal, layers);
  }

  // ‚îÄ‚îÄ CIVILIZATION DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const civGameData = cfg.civData.map((c, i) => {
    const cont = continents[i % continents.length];
    const capitalX = cont.cx + rand(-80, 80);
    const capitalY = cont.cy + rand(-60, 60);
    const startPop = cfg.conditions.sparse ? randInt(20, 60)
                   : cfg.conditions.advanced ? randInt(200, 500)
                   : randInt(80, 180);
    const mil = c.trait.name === 'Aggressive' ? 85 : c.trait.name === 'Nomadic' ? 75 : randInt(40, 70);
    const sci = c.trait.name === 'Scholar' ? 95 : c.trait.name === 'Arcane' ? 90 : randInt(40, 70);
    const cult = c.trait.name === 'Merchant' ? 85 : c.trait.name === 'Maritime' ? 75 : randInt(40, 70);
    return {
      id: c.id, name: c.name, color: c.color, trait: c.trait,
      capital: { x: capitalX, y: capitalY, name: c.name.split(' ')[0] + ' Prime' },
      population: startPop, growth: rand(0.8, 1.8),
      military: mil, science: sci, culture: cult,
      age: 0, territory: 1, expansion: rand(0.3, 0.9),
      desc: `${c.trait.emoji} ${c.trait.name} civilization.`,
      wonder: null,
      relations: {}
    };
  });

  // ‚îÄ‚îÄ CITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const cities = [];
  civGameData.forEach((civ, ci) => {
    cities.push({
      civIdx: ci, x: civ.capital.x, y: civ.capital.y,
      name: civ.capital.name, size: 'capital',
      pop: civ.population * 500, active: true, founded: cfg.startYear
    });
    const cityCount = cfg.conditions.cities ? randInt(2, 4) : randInt(1, 2);
    for (let j = 0; j < cityCount; j++) {
      const cont = continents[ci % continents.length];
      cities.push({
        civIdx: ci,
        x: cont.cx + rand(-cont.w * 0.4, cont.w * 0.4),
        y: cont.cy + rand(-cont.h * 0.4, cont.h * 0.4),
        name: generateCityName(),
        size: j === 0 ? 'major' : 'town',
        pop: civ.population * (j === 0 ? 200 : 80),
        active: true, founded: cfg.startYear
      });
    }
  });

  // ‚îÄ‚îÄ RELATIONS MATRIX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const n = civGameData.length;
  const relations = Array.from({ length: n }, () => Array(n).fill(0));
  if (cfg.conditions.hostile) {
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++) {
        const v = -1 - (Math.random() < 0.4 ? 1 : 0);
        relations[i][j] = relations[j][i] = v;
      }
  } else if (cfg.conditions.neutral) {
    // all 0
  } else {
    for (let i = 0; i < n; i++)
      for (let j = i + 1; j < n; j++) {
        const v = randInt(-2, 2);
        relations[i][j] = relations[j][i] = v;
      }
  }

  // ‚îÄ‚îÄ TRADE ROUTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tradeRoutes = [];
  if (cfg.traits.trade) {
    for (let i = 0; i < n; i++) {
      const j = (i + 1) % n;
      if (relations[i][j] >= 0) {
        const cA = cities.find(c => c.civIdx === i && c.size === 'capital');
        const cB = cities.find(c => c.civIdx === j && c.size === 'capital');
        if (cA && cB) tradeRoutes.push({ from: cA, to: cB, civA: i, civB: j, active: true, age: 0 });
      }
    }
  }

  // ‚îÄ‚îÄ MILITARY UNITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const units = [];
  civGameData.forEach((civ, ci) => {
    const capital = cities.find(c => c.civIdx === ci && c.size === 'capital');
    if (!capital) return;
    const unitType = civ.trait.name === 'Maritime' ? 'fleet' : civ.trait.name === 'Arcane' ? 'mage' : 'army';
    units.push({
      civIdx: ci, x: capital.x + rand(-40, 40), y: capital.y + rand(-30, 30),
      type: unitType, size: randInt(2, 5),
      vx:0, vy:0, targetX: capital.x, targetY: capital.y,
      phase: rand(0, Math.PI * 2), fighting: false, fightTimer: 0
    });
  });

  // ‚îÄ‚îÄ WORLD STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  worldState = {
    W, H, cfg, pal, layers, defs, svg,
    civs: civGameData, cities, relations, tradeRoutes, units,
    continents,
    year: cfg.startYear,
    totalWonders: 0, totalCitiesCount: cities.length,
    events: [],
    tradeElems: [],
  };

  // ‚îÄ‚îÄ INITIAL RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderAll(worldState);
  updateHUD(worldState);

  // ‚îÄ‚îÄ HUD: Civ Legend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const legendRows = document.getElementById('civ-legend-rows');
  legendRows.innerHTML = '';
  civGameData.forEach(c => {
    const row = document.createElement('div');
    row.className = 'legend-row';
    row.innerHTML = `<div class="legend-dot" style="background:${c.color};box-shadow:0 0 5px ${c.color}"></div>
      <span>${c.name}</span><span class="legend-pop" id="lpop-${c.id}">‚Äî</span>`;
    legendRows.appendChild(row);
  });

  document.getElementById('hud-planet-name').textContent = cfg.name.toUpperCase();

  // ‚îÄ‚îÄ LOG initial events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  logEvent(worldState, `${cfg.name} emerges from the void.`, 'culture');
  civGameData.forEach(c => logEvent(worldState, `${c.name} rise to prominence. ${c.trait.emoji}`, 'peace'));

  // ‚îÄ‚îÄ SIM LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const baseInterval = 1200;
  const interval = Math.round(baseInterval / cfg.simSpeed);
  simInterval = setInterval(() => simTick(worldState), interval);

  // ‚îÄ‚îÄ CREATURE SYSTEM INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  setTimeout(() => {
    if (!worldState) return;
    initContinentCreatures(worldState);
    addContinentClickZones(worldState);
    wireCreatureActions(worldState);
    interactionEntries = [];
  }, 150);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTINENT GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function generateContinents(W, H, count, landFrac, pal, defs, layers) {
  const continents = [];
  const margin = 80;
  const placed = [];

  for (let i = 0; i < count; i++) {
    let cx, cy, attempts = 0;
    do {
      cx = rand(margin + W * 0.05, W - margin - W * 0.05);
      cy = rand(margin + H * 0.08, H - margin - H * 0.08);
      attempts++;
    } while (attempts < 30 && placed.some(p => dist(cx, cy, p.cx, p.cy) < 130));

    const w = rand(100, Math.min(W * 0.25, 220)) * (0.5 + landFrac);
    const h = rand(70, Math.min(H * 0.25, 160)) * (0.5 + landFrac);
    const pts = generateBlobPoints(cx, cy, w * 0.5, h * 0.5, 10);
    const fill = pal.land[i % pal.land.length];
    const fill2 = pal.land[(i + 1) % pal.land.length];

    // Gradient
    const gid = `cont-g-${i}`;
    const cg = el('linearGradient', { id: gid, x1:'0', y1:'0', x2:'0.3', y2:'1', gradientUnits:'objectBoundingBox' }, defs);
    el('stop', { offset:'0%', 'stop-color': fill }, cg);
    el('stop', { offset:'100%', 'stop-color': fill2 }, cg);

    const ptStr = pts.map(p => p.join(',')).join(' ');
    el('polygon', { points: ptStr, fill: `url(#${gid})`, stroke:'rgba(0,0,0,0.3)', 'stroke-width':'1.5' }, layers['terrain']);
    el('polygon', { points: ptStr, fill:'none', stroke:'rgba(255,255,255,0.07)', 'stroke-width':'2' }, layers['terrain']);

    // Texture bumps
    for (let j = 0; j < 6; j++) {
      const bx = cx + rand(-w * 0.35, w * 0.35);
      const by = cy + rand(-h * 0.35, h * 0.35);
      el('ellipse', { cx: bx, cy: by, rx: rand(8, 28), ry: rand(4, 14),
        fill: `rgba(0,0,0,0.12)`,
        transform: `rotate(${rand(0,180)},${bx},${by})` }, layers['terrain']);
    }

    placed.push({ cx, cy });
    continents.push({ cx, cy, w, h, pts, fill, i });
  }

  return continents;
}

function generateBlobPoints(cx, cy, rx, ry, numPts) {
  const pts = [];
  for (let i = 0; i < numPts; i++) {
    const angle = (i / numPts) * Math.PI * 2;
    const jitter = rand(0.6, 1.4);
    const x = cx + Math.cos(angle) * rx * jitter;
    const y = cy + Math.sin(angle) * ry * jitter;
    pts.push([Math.round(x), Math.round(y)]);
  }
  return pts;
}

function generateRivers(W, H, continents, pal, layers) {
  continents.forEach(c => {
    if (Math.random() < 0.6) {
      const startX = c.cx + rand(-c.w * 0.2, c.w * 0.2);
      const startY = c.cy - c.h * 0.3;
      const endX = c.cx + rand(-c.w * 0.3, c.w * 0.3);
      const endY = c.cy + c.h * 0.5;
      const mx = startX + rand(-40, 40);
      const my = (startY + endY) / 2;
      const d = `M${startX},${startY} Q${mx},${my} ${endX},${endY}`;
      el('path', { d, fill:'none', stroke: pal.river, 'stroke-width':'2', 'stroke-linecap':'round' }, layers['rivers']);
      el('path', { d, fill:'none', stroke:'rgba(100,200,255,0.12)', 'stroke-width':'5', 'stroke-linecap':'round', filter:'url(#soft)' }, layers['rivers']);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderAll(ws) {
  renderTerritories(ws);
  renderBorders(ws);
  if (ws.cfg.ecoMode === 'earth') {
    renderEarthCreatures(ws); 
  } else {
    renderUnits(ws); 
  }
  
  renderCities(ws);
}

function renderTerritories(ws) {
  ws.layers['territory'].innerHTML = '';
  ws.cities.filter(c => c.active).forEach(c => {
    const civ = ws.civs[c.civIdx];
    if (!civ) return;
    const r = c.size === 'capital' ? 95 : c.size === 'major' ? 65 : 38;
    const tid = `tg-${Math.round(c.x)}-${Math.round(c.y)}`;
    const tg = el('radialGradient', { id: tid, cx:'50%', cy:'50%', r:'50%' }, ws.defs);
    el('stop', { offset:'0%', 'stop-color': civ.color, 'stop-opacity':'0.20' }, tg);
    el('stop', { offset:'100%', 'stop-color': civ.color, 'stop-opacity':'0' }, tg);
    el('ellipse', { cx: c.x, cy: c.y, rx: r, ry: r * 0.75, fill: `url(#${tid})` }, ws.layers['territory']);
  });
}

function renderBorders(ws) {
  ws.layers['borders'].innerHTML = '';
  ws.civs.forEach((civ, ci) => {
    const cvCities = ws.cities.filter(c => c.civIdx === ci && c.active);
    cvCities.forEach(c => {
      const r = c.size === 'capital' ? 80 : c.size === 'major' ? 55 : 32;
      el('ellipse', { cx: c.x, cy: c.y, rx: r, ry: r * 0.7,
        fill:'none', stroke: civ.color, 'stroke-width':'1.2',
        'stroke-dasharray':'4 7', opacity:'0.35' }, ws.layers['borders']);
    });
  });
}

function renderTradeRoutes(ws) {
  ws.layers['trade'].innerHTML = '';
  ws.tradeElems = [];
  ws.tradeRoutes.filter(r => r.active).forEach(r => {
    const civA = ws.civs[r.civA];
    const civB = ws.civs[r.civB];
    if (!civA || !civB) return;
    const midX = (r.from.x + r.to.x) / 2 + rand(-20, 20);
    const midY = (r.from.y + r.to.y) / 2 + rand(-20, 20);
    const d = `M${r.from.x},${r.from.y} Q${midX},${midY} ${r.to.x},${r.to.y}`;
    el('path', { d, fill:'none', stroke: civA.color, 'stroke-width':'1.5',
      'stroke-dasharray':'6 10', opacity:'0.4' }, ws.layers['trade']);
    // Ship dot
    const shipDot = el('circle', { cx: r.from.x, cy: r.from.y, r: 3,
      fill: civA.color, filter:'url(#g4)' }, ws.layers['trade']);
    ws.tradeElems.push({ el: shipDot, path: d, t: Math.random(), speed: rand(0.003, 0.007) });
  });
}

function renderCities(ws) {
  ws.layers['structures'].innerHTML = '';
  ws.cities.filter(c => c.active).forEach(c => {
    const civ = ws.civs[c.civIdx];
    if (!civ) return;
    const sz = c.size === 'capital' ? 7 : c.size === 'major' ? 5 : 3.5;
    const g = el('g', { cursor:'pointer' }, ws.layers['structures']);
    // glow
    el('circle', { cx: c.x, cy: c.y, r: sz + 5, fill: civ.color, opacity:'0.15', filter:'url(#g8)' }, g);
    // dot
    el('circle', { cx: c.x, cy: c.y, r: sz, fill: civ.color, filter:`url(#g${c.size==='capital'?4:2})` }, g);
    // ring for capitals
    if (c.size === 'capital') {
      el('circle', { cx: c.x, cy: c.y, r: sz + 5, fill:'none', stroke: civ.color, 'stroke-width':'1', opacity:'0.5' }, g);
    }
    // label
    el('text', { x: c.x, y: c.y - 10, fill: civ.color, 'font-size': c.size==='capital'?'8':'6.5',
      'text-anchor':'middle', 'font-family':'Space Mono,monospace', 'letter-spacing':'1' }, g).textContent = c.name;

    // Tooltip
    g.addEventListener('mouseenter', ev => {
      document.getElementById('tt-name').textContent = c.name;
      document.getElementById('tt-body').textContent =
        `${civ.name} ${c.size} | Pop. ${Math.round(c.pop).toLocaleString()} | Founded ${c.founded}`;
      const t = document.getElementById('tooltip');
      t.style.display = 'block';
      t.style.left = (ev.clientX + 15) + 'px';
      t.style.top  = (ev.clientY - 40) + 'px';
    });
    g.addEventListener('mousemove', ev => {
      const t = document.getElementById('tooltip');
      t.style.left = (ev.clientX + 15) + 'px';
      t.style.top  = (ev.clientY - 40) + 'px';
    });
    g.addEventListener('mouseleave', () => {
      document.getElementById('tooltip').style.display = 'none';
    });
  });
}

function renderEarthCreatures(ws, contIdx) {
  const container = document.getElementById('creature-scene');
  const creatures = continentCreatures[contIdx] || [];
  
  // Clear or update existing elements
  creatures.forEach((c, i) => {
    let el = document.getElementById(`creature-${i}`);
    
    if (!el) {
      // Determine if we need an SVG shape or a Text Emoji
      const isEmoji = !CREATURE_SHAPES[c.def.shape];
      
      if (isEmoji) {
        // Create a <text> element for Earth creatures
        el = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        el.setAttribute('id', `creature-${i}`);
        el.setAttribute('text-anchor', 'middle');
        el.setAttribute('dominant-baseline', 'central');
        el.style.fontSize = '24px'; // Adjust size as needed
        el.textContent = c.def.shape;
      } else {
        // Create a <g> element for Alien/SVG creatures
        el = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        el.setAttribute('id', `creature-${i}`);
        const drawFn = CREATURE_SHAPES[c.def.shape] || CREATURE_SHAPES['zhaun'];
        const color = getCreatureColor(c.def, ws.cfg.biome);
        drawFn(el, 0, 0, 12, color);
      }
      container.appendChild(el);
    }

    // --- ANIMATION LOGIC ---
    // Update position (same for both types)
    c.x += c.vx;
    // Add a little "bounce" or "phase" movement
    const wobble = Math.sin(Date.now() * 0.002 + c.phase) * 2;
    
    // Use transform to move them so we don't care if it's <text> or <g>
    el.setAttribute('transform', `translate(${c.x}, ${c.y + wobble})`);
    
    // Flip based on direction
    const scaleX = c.vx > 0 ? 1 : -1;
    el.setAttribute('transform', `translate(${c.x}, ${c.y + wobble}) scale(${scaleX}, 1)`);
  });
}

function renderUnits(ws) {
  ws.layers['units'].innerHTML = '';
  ws.units.forEach(u => {
    const civ = ws.civs[u.civIdx];
    if (!civ) return;
    const sym = u.type === 'fleet' ? '‚õµ' : u.type === 'mage' ? '‚ú¶' : u.type === 'cavalry' ? 'üêé' : '‚öî';
    const g = el('g', {}, ws.layers['units']);
    el('text', { x: u.x, y: u.y + 4, fill:'white', 'font-size':'8', 'text-anchor':'middle',
      filter:'url(#g2)' }, g).textContent = sym;
    // size indicator
    el('text', { x: u.x + 7, y: u.y - 1, fill: civ.color, 'font-size':'5.5', 'text-anchor':'middle' }, g)
      .textContent = u.size;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIMULATION TICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function simTick(ws) {
  ws.year++;
  const { civs, relations, cities, tradeRoutes, units, cfg, W, H } = ws;

  // Advance ages
  const ageThresholds = [1, 50, 150, 300, 500, 700, 900, 1100, 1400];
  civs.forEach(c => {
    const ageIdx = ageThresholds.findIndex(t => ws.year < t);
    const newAge = ageIdx < 0 ? AGES.length - 1 : Math.max(0, ageIdx - 1);
    if (newAge > c.age) {
      c.age = newAge;
      logEvent(ws, `${c.name} enters the ${AGES[c.age]}!`, 'culture');
    }
  });

  // Population growth
  civs.forEach(c => {
    const pollutionFactor = cfg.traits.plagues && Math.random() < 0.02 ? 0.7 : 1;
    c.population = c.population * (1 + (c.growth - 1) * 0.05) * pollutionFactor;
    if (cfg.traits.plagues && Math.random() < 0.005) {
      c.population *= 0.75;
      logEvent(ws, `Plague ravages ${c.name}! Population falls.`, 'war');
    }
  });

  // Civ population into cities
  cities.forEach(c => {
    if (!c.active) return;
    const civ = civs[c.civIdx];
    if (!civ) return;
    c.pop = civ.population * (c.size === 'capital' ? 500 : c.size === 'major' ? 200 : 80);
  });

  // Diplomacy events
  if (cfg.traits.wars && Math.random() < 0.08) {
    const i = randInt(0, civs.length - 1);
    const j = randInt(0, civs.length - 1);
    if (i !== j && relations[i]?.[j] !== undefined) {
      const prev = relations[i][j];
      if (relations[i][j] > -2) relations[i][j]--;
      if (relations[j][i] > -2) relations[j][i]--;
      if (prev === -1 && relations[i][j] === -2) {
        logEvent(ws, `${civs[i].name} declares WAR on ${civs[j].name}! ‚öî`, 'war');
      }
    }
  }
  if (cfg.traits.alliances && Math.random() < 0.05) {
    const i = randInt(0, civs.length - 1);
    const j = randInt(0, civs.length - 1);
    if (i !== j && relations[i]?.[j] !== undefined) {
      if (relations[i][j] < 2) { relations[i][j]++; relations[j][i]++; }
      if (relations[i][j] === 2) {
        logEvent(ws, `${civs[i].name} & ${civs[j].name} form an alliance! ü§ù`, 'peace');
      }
    }
  }

  // Trade route changes
  if (cfg.traits.trade) {
    tradeRoutes.forEach(r => {
      r.age++;
      const goodRelations = relations[r.civA]?.[r.civB] >= 0;
      if (r.active && !goodRelations && Math.random() < 0.1) {
        r.active = false;
        logEvent(ws, `Trade route between ${civs[r.civA]?.name} & ${civs[r.civB]?.name} severed.`, 'neutral');
      } else if (!r.active && goodRelations && Math.random() < 0.05) {
        r.active = true;
        logEvent(ws, `Trade resumes between ${civs[r.civA]?.name} & ${civs[r.civB]?.name}.`, 'peace');
      }
    });
  }

  // New city founded
  if (Math.random() < 0.04) {
    const civIdx = randInt(0, civs.length - 1);
    const civ = civs[civIdx];
    const cont = ws.continents[civIdx % ws.continents.length];
    if (civ && cont) {
      const newCity = {
        civIdx, x: cont.cx + rand(-cont.w * 0.5, cont.w * 0.5),
        y: cont.cy + rand(-cont.h * 0.5, cont.h * 0.5),
        name: generateCityName(), size: 'town',
        pop: civ.population * 40, active: true, founded: ws.year
      };
      ws.cities.push(newCity);
      ws.totalCitiesCount++;
      logEvent(ws, `${civ.name} founds ${newCity.name}! üèô`, 'culture');
    }
  }

  // Wonder
  if (cfg.traits.wonders && Math.random() < 0.015) {
    const civIdx = randInt(0, civs.length - 1);
    const civ = civs[civIdx];
    if (civ) {
      ws.totalWonders++;
      logEvent(ws, `${civ.name} completes a World Wonder! ‚ú®`, 'wonder');
    }
  }

  // Golden age
  if (cfg.traits['golden-age'] && Math.random() < 0.012) {
    const civ = civs[randInt(0, civs.length - 1)];
    if (civ) {
      civ.growth = Math.min(2.5, civ.growth + 0.2);
      logEvent(ws, `${civ.name} enters a Golden Age! üåü`, 'wonder');
    }
  }

  // Cataclysm
  if (cfg.traits.cataclysm && Math.random() < 0.008) {
    const civ = civs[randInt(0, civs.length - 1)];
    if (civ) {
      civ.population *= 0.6;
      logEvent(ws, `CATACLYSM strikes ${civ.name}! üí•`, 'war');
    }
  }

  // Move units
  units.forEach(u => {
    u.phase += 0.1;
    const civ = civs[u.civIdx];
    if (!civ) return;
    const tx = u.targetX + Math.sin(u.phase * 0.3) * 30;
    const ty = u.targetY + Math.cos(u.phase * 0.4) * 20;
    u.x += (tx - u.x) * 0.06;
    u.y += (ty - u.y) * 0.06;
    // Occasionally move unit toward enemy territory
    if (Math.random() < 0.01) {
      const rival = civs.find((c, j) => c !== civ && relations[u.civIdx]?.[j] <= -1);
      if (rival) {
        const rCity = cities.find(c => c.civIdx === civs.indexOf(rival) && c.active);
        if (rCity) { u.targetX = rCity.x + rand(-50, 50); u.targetY = rCity.y + rand(-40, 40); }
      } else {
        const home = cities.find(c => c.civIdx === u.civIdx && c.size === 'capital');
        if (home) { u.targetX = home.x + rand(-60, 60); u.targetY = home.y + rand(-50, 50); }
      }
    }
  });

  // Animate trade ships
  ws.tradeElems.forEach(te => {
    te.t = (te.t + te.speed) % 1;
    const pt = getPointOnQuadratic(te.path, te.t);
    if (pt) {
      te.el.setAttribute('cx', pt.x);
      te.el.setAttribute('cy', pt.y);
    }
  });

  // Re-render
  renderAll(ws);
  updateHUD(ws);
}

// ‚îÄ‚îÄ Quadratic bezier interpolation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getPointOnQuadratic(pathStr, t) {
  try {
    const m = pathStr.match(/M([\d.]+),([\d.]+) Q([\d.]+),([\d.]+) ([\d.]+),([\d.]+)/);
    if (!m) return null;
    const [, x0, y0, cx, cy, x1, y1] = m.map(Number);
    const x = (1-t)*(1-t)*x0 + 2*(1-t)*t*cx + t*t*x1;
    const y = (1-t)*(1-t)*y0 + 2*(1-t)*t*cy + t*t*y1;
    return { x, y };
  } catch { return null; }
}

// ‚îÄ‚îÄ HUD UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHUD(ws) {
  const totalPop = ws.civs.reduce((s, c) => s + c.population, 0);
  const wars = countWars(ws);
  const activeTrade = ws.tradeRoutes.filter(r => r.active).length;
  const age = ws.civs[0] ? AGES[ws.civs[0].age] : '‚Äî';

  document.getElementById('s-age').textContent = age;
  document.getElementById('s-year').textContent = ws.year;
  document.getElementById('year-counter').textContent = ws.year;
  document.getElementById('s-pop').textContent = Math.round(totalPop).toLocaleString();
  document.getElementById('s-wars').textContent = wars;
  document.getElementById('s-trade').textContent = activeTrade;
  document.getElementById('s-cities').textContent = ws.totalCitiesCount;

  ws.civs.forEach(c => {
    const el = document.getElementById(`lpop-${c.id}`);
    if (el) el.textContent = Math.round(c.population).toLocaleString();
  });
}

function countWars(ws) {
  let n = 0;
  const nc = ws.civs.length;
  for (let i = 0; i < nc; i++)
    for (let j = i + 1; j < nc; j++)
      if (ws.relations[i]?.[j] === -2) n++;
  return n;
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function logEvent(ws, text, type = 'neutral') {
  ws.events.unshift({ text, type, year: ws.year });
  if (ws.events.length > 15) ws.events.pop();
  const container = document.getElementById('events-container');
  container.innerHTML = '';
  ws.events.slice(0, 6).forEach(e => {
    const div = document.createElement('div');
    div.className = `event-entry ${e.type}`;
    div.textContent = `Yr.${e.year} ‚Äî ${e.text}`;
    container.appendChild(div);
  });
}

// ‚îÄ‚îÄ CITY NAME GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CITY_PREFIXES = ['Kel','Vor','Ash','Thal','Solz','Nex','Drak','Lum','Orr','Quel','Aur','Syx','Neth','Vel','Krath'];
const CITY_SUFFIXES = ['haven','gate','spire','keep','hold','watch','march','fall','bridge','ford','port','moor','vale','heim','mark'];
function generateCityName() {
  return CITY_PREFIXES[randInt(0, CITY_PREFIXES.length-1)] + CITY_SUFFIXES[randInt(0, CITY_SUFFIXES.length-1)];
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATURE INTERACTION SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ SVG CREATURE SHAPE DRAWERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Each draws a unique alien silhouette as SVG path/shapes.
// draw(parent, x, y, sz, color) ‚Äî appends to parent <g>, returns root el.
const CREATURE_SHAPES = {
  // ‚îÄ‚îÄ Lumbering tri-legged grazer
  threll: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('ellipse',{cx:0,cy:0,rx:s*.55,ry:s*.35,fill:c,opacity:'0.9'},g);
    svgEl('path',{d:`M${-s*.2},${s*.3} L${-s*.35},${s*.7} M0,${s*.35} L0,${s*.75} M${s*.2},${s*.3} L${s*.35},${s*.7}`,stroke:c,'stroke-width':s*.1,'stroke-linecap':'round',fill:'none'},g);
    svgEl('ellipse',{cx:s*.45,cy:-s*.05,rx:s*.18,ry:s*.13,fill:c},g);
    svgEl('circle',{cx:s*.58,cy:-s*.07,r:s*.05,fill:'rgba(255,255,255,0.7)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Sinuous skimmer ‚Äî long body, fin ridge
  velkor: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('path',{d:`M${-s*.7},0 C${-s*.3},${-s*.2} ${s*.3},${-s*.2} ${s*.7},0 C${s*.3},${s*.15} ${-s*.3},${s*.15} ${-s*.7},0 Z`,fill:c,opacity:'0.95'},g);
    svgEl('path',{d:`M${-s*.1},${-s*.2} L0,${-s*.5} L${s*.1},${-s*.2}`,fill:c,opacity:'0.7'},g);
    svgEl('circle',{cx:s*.6,cy:-s*.03,r:s*.06,fill:'rgba(255,255,255,0.8)'},g);
    svgEl('path',{d:`M${-s*.7},0 L${-s*.95},${-s*.12} M${-s*.7},0 L${-s*.95},${s*.12}`,stroke:c,'stroke-width':s*.08,fill:'none','stroke-linecap':'round'},g);
    return g;
  },
  // ‚îÄ‚îÄ Spiked radial ‚Äî floats and pulses
  zhaun: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('circle',{cx:0,cy:0,r:s*.38,fill:c,opacity:'0.85'},g);
    for(let i=0;i<6;i++){const a=i/6*Math.PI*2;svgEl('line',{x1:Math.cos(a)*s*.38,y1:Math.sin(a)*s*.38,x2:Math.cos(a)*s*.7,y2:Math.sin(a)*s*.7,stroke:c,'stroke-width':s*.08,'stroke-linecap':'round'},g);}
    svgEl('circle',{cx:0,cy:0,r:s*.15,fill:'rgba(255,255,255,0.4)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Hulking quadruped ‚Äî apex bruiser
  orrath: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('rect',{x:-s*.5,y:-s*.3,width:s,height:s*.55,rx:s*.1,fill:c},g);
    svgEl('rect',{x:s*.45,y:-s*.38,width:s*.35,height:s*.3,rx:s*.07,fill:c},g);
    svgEl('line',{x1:-s*.5,y1:s*.25,x2:-s*.5,y2:s*.65,stroke:c,'stroke-width':s*.14,'stroke-linecap':'round'},g);
    svgEl('line',{x1:-s*.2,y1:s*.25,x2:-s*.2,y2:s*.65,stroke:c,'stroke-width':s*.14,'stroke-linecap':'round'},g);
    svgEl('line',{x1:s*.2,y1:s*.25,x2:s*.2,y2:s*.65,stroke:c,'stroke-width':s*.14,'stroke-linecap':'round'},g);
    svgEl('line',{x1:s*.5,y1:s*.25,x2:s*.5,y2:s*.65,stroke:c,'stroke-width':s*.14,'stroke-linecap':'round'},g);
    svgEl('circle',{cx:s*.72,cy:-s*.28,r:s*.08,fill:'rgba(255,100,50,0.9)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Wispy floater ‚Äî lightweight prey
  sylph: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('ellipse',{cx:0,cy:0,rx:s*.25,ry:s*.4,fill:c,opacity:'0.8'},g);
    svgEl('path',{d:`M${-s*.25},${s*.1} Q${-s*.55},${s*.4} ${-s*.35},${s*.65}`,stroke:c,'stroke-width':s*.07,fill:'none','stroke-linecap':'round'},g);
    svgEl('path',{d:`M${s*.25},${s*.1} Q${s*.55},${s*.4} ${s*.35},${s*.65}`,stroke:c,'stroke-width':s*.07,fill:'none','stroke-linecap':'round'},g);
    svgEl('circle',{cx:0,cy:-s*.3,r:s*.12,fill:c,opacity:'0.6'},g);
    return g;
  },
  // ‚îÄ‚îÄ Mantis-like ambush predator
  kethis: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('path',{d:`M0,${-s*.5} L${s*.15},0 L0,${s*.5} L${-s*.15},0 Z`,fill:c,opacity:'0.9'},g);
    svgEl('path',{d:`M${s*.15},${-s*.1} L${s*.6},${-s*.4} L${s*.5},${s*.1}`,stroke:c,'stroke-width':s*.09,fill:'none','stroke-linecap':'round'},g);
    svgEl('path',{d:`M${-s*.15},${-s*.1} L${-s*.6},${-s*.4} L${-s*.5},${s*.1}`,stroke:c,'stroke-width':s*.09,fill:'none','stroke-linecap':'round'},g);
    svgEl('circle',{cx:0,cy:-s*.55,r:s*.1,fill:c},g);
    svgEl('circle',{cx:s*.05,cy:-s*.55,r:s*.04,fill:'rgba(255,255,100,0.9)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Rolling shell creature
  vorrn: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('circle',{cx:0,cy:0,r:s*.4,fill:c,opacity:'0.85'},g);
    svgEl('path',{d:`M${-s*.2},${-s*.35} L0,${-s*.15} L${s*.2},${-s*.35}`,stroke:'rgba(0,0,0,0.3)','stroke-width':s*.06,fill:'none'},g);
    svgEl('path',{d:`M${-s*.38},${s*.1} Q0,${-s*.1} ${s*.38},${s*.1}`,stroke:'rgba(0,0,0,0.2)','stroke-width':s*.05,fill:'none'},g);
    svgEl('ellipse',{cx:s*.32,cy:-s*.2,rx:s*.08,ry:s*.06,fill:'rgba(255,255,255,0.5)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Elongated burrower ‚Äî ground-dweller
  neth: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('ellipse',{cx:0,cy:0,rx:s*.7,ry:s*.22,fill:c,opacity:'0.9'},g);
    svgEl('path',{d:`M${s*.55},${-s*.15} L${s*.85},${-s*.3} M${s*.55},0 L${s*.9},0 M${s*.55},${s*.15} L${s*.85},${s*.3}`,stroke:c,'stroke-width':s*.08,'stroke-linecap':'round',fill:'none'},g);
    svgEl('circle',{cx:-s*.65,cy:0,r:s*.14,fill:c},g);
    svgEl('circle',{cx:-s*.68,cy:-s*.05,r:s*.05,fill:'rgba(200,255,255,0.8)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Aerial glider ‚Äî membrane wings
  skrave: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('ellipse',{cx:0,cy:0,rx:s*.2,ry:s*.35,fill:c},g);
    svgEl('path',{d:`M${-s*.2},${-s*.05} Q${-s*.7},${-s*.3} ${-s*.8},${s*.1} Q${-s*.5},${s*.2} ${-s*.2},${s*.1}`,fill:c,opacity:'0.7'},g);
    svgEl('path',{d:`M${s*.2},${-s*.05} Q${s*.7},${-s*.3} ${s*.8},${s*.1} Q${s*.5},${s*.2} ${s*.2},${s*.1}`,fill:c,opacity:'0.7'},g);
    svgEl('circle',{cx:0,cy:-s*.3,r:s*.09,fill:c},g);
    return g;
  },
  // ‚îÄ‚îÄ Multi-arm scuttler ‚Äî ambush
  draxis: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('ellipse',{cx:0,cy:0,rx:s*.35,ry:s*.28,fill:c,opacity:'0.95'},g);
    for(let i=0;i<8;i++){const a=-Math.PI/2+i/8*Math.PI*2;const r1=s*.35;const r2=s*.7;svgEl('line',{x1:Math.cos(a)*r1,y1:Math.sin(a)*r1,x2:Math.cos(a)*r2,y2:Math.sin(a)*r2,stroke:c,'stroke-width':s*.07,'stroke-linecap':'round'},g);}
    svgEl('circle',{cx:0,cy:0,r:s*.12,fill:'rgba(255,80,80,0.7)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Towering stalker ‚Äî tall body
  vexar: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    svgEl('rect',{x:-s*.12,y:-s*.65,width:s*.24,height:s*.9,rx:s*.06,fill:c,opacity:'0.9'},g);
    svgEl('ellipse',{cx:0,cy:-s*.65,rx:s*.2,ry:s*.16,fill:c},g);
    svgEl('line',{x1:-s*.12,y1:s*.15,x2:-s*.35,y2:s*.55,stroke:c,'stroke-width':s*.1,'stroke-linecap':'round'},g);
    svgEl('line',{x1:s*.12,y1:s*.15,x2:s*.35,y2:s*.55,stroke:c,'stroke-width':s*.1,'stroke-linecap':'round'},g);
    svgEl('circle',{cx:s*.08,cy:-s*.68,r:s*.06,fill:'rgba(255,200,50,0.9)'},g);
    svgEl('circle',{cx:-s*.06,cy:-s*.68,r:s*.04,fill:'rgba(255,200,50,0.9)'},g);
    return g;
  },
  // ‚îÄ‚îÄ Crystalline floater ‚Äî void creature
  qythe: (p,x,y,s,c) => {
    const g = svgEl('g',{transform:`translate(${x},${y})`},p);
    const pts = [];for(let i=0;i<5;i++){const a=i/5*Math.PI*2-Math.PI/2;pts.push(Math.cos(a)*s*.45+','+Math.sin(a)*s*.45);}
    svgEl('polygon',{points:pts.join(' '),fill:c,opacity:'0.7','stroke':'rgba(255,255,255,0.3)','stroke-width':s*.05},g);
    svgEl('circle',{cx:0,cy:0,r:s*.15,fill:'rgba(255,255,255,0.5)'},g);
    for(let i=0;i<5;i++){const a=i/5*Math.PI*2-Math.PI/2;svgEl('line',{x1:0,y1:0,x2:Math.cos(a)*s*.45,y2:Math.sin(a)*s*.45,stroke:'rgba(255,255,255,0.2)','stroke-width':s*.04},g);}
    return g;
  },
};

// Shared SVG element helper for creature drawings
function svgEl(tag, attrs, parent) {
  const e = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for (const [k, v] of Object.entries(attrs)) e.setAttribute(k, String(v));
  if (parent) parent.appendChild(e);
  return e;
}

// ‚îÄ‚îÄ CREATURE COLOR PALETTES PER BIOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BIOME_CREATURE_COLORS = {
  temperate: ['#6abf69','#a5d6a7','#81c784','#4caf50','#2e7d32','#c8e6c9'],
  desert:    ['#ffb74d','#ffa726','#e65100','#d4a030','#bf8040','#f5c842'],
  ocean:     ['#4dd0e1','#26c6da','#00acc1','#0097a7','#a5f3fc','#67e8f9'],
  jungle:    ['#69f0ae','#1de9b6','#00e676','#76ff03','#b2ff59','#ccff90'],
  arctic:    ['#b3e5fc','#e1f5fe','#81d4fa','#4fc3f7','#c5cae9','#dcedc8'],
  volcanic:  ['#ff6e40','#ff3d00','#dd2c00','#bf360c','#e64a19','#ff7043'],
  crystal:   ['#ce93d8','#ba68c8','#ab47bc','#9c27b0','#e1bee7','#f3e5f5'],
  void:      ['#9575cd','#7e57c2','#673ab7','#512da8','#b39ddb','#ede7f6'],
};

// ‚îÄ‚îÄ EARTH CREATURE DEFINITIONS PER BIOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EARTH_CREATURES = {
  temperate: [
    { id:'deer',    shape:'ü¶å', name:'Red Deer',     role:'herbivore', count:[4,8], speed:1.2, fearful:true,  color:0 },
    { id:'wolf',    shape:'üêï', name:'Grey Wolf',    role:'predator',  count:[2,4], speed:1.5, fearful:false, color:1 }, // 'üêï' looks more like a moving body than 'üê∫'
    { id:'bear',    shape:'üß∏', name:'Grizzly Bear', role:'apex',      count:[1,2], speed:1.0, fearful:false, color:2 }, // 'üß∏' is often the only full bear, but 'üêª' is usually preferred. Try 'ü¶´' (Beaver) as a substitute for body shape?
    { id:'rabbit',  shape:'üêá', name:'Wild Rabbit',  role:'prey',      count:[6,10],speed:1.8, fearful:true,  color:3 },
    { id:'fox',     shape:'ü¶ä', name:'Red Fox',      role:'predator',  count:[2,4], speed:1.4, fearful:false, color:4 }, // Note: Fox is head-only in many sets; 'üêï' tinted orange is a common dev trick
    { id:'owl',     shape:'ü¶â', name:'Forest Owl',   role:'predator',  count:[1,3], speed:1.1, fearful:false, color:5 },
  ],
  desert: [
    { id:'coyote',  shape:'üêï', name:'Coyote',       role:'predator',  count:[2,5], speed:1.3, fearful:false, color:0 },
    { id:'camel',   shape:'üê´', name:'Camel',        role:'herbivore', count:[2,4], speed:0.8, fearful:false, color:1 },
    { id:'lion',    shape:'ü¶Å', name:'Desert Lion',  role:'apex',      count:[1,2], speed:1.4, fearful:false, color:2 }, 
    { id:'jerboa',  shape:'üê≠', name:'Jerboa',       role:'prey',      count:[5,9], speed:1.6, fearful:true,  color:3 },
    { id:'scorpion',shape:'ü¶Ç', name:'Scorpion',     role:'predator',  count:[3,6], speed:0.7, fearful:false, color:4 },
    { id:'lizard',  shape:'ü¶é', name:'Sand Lizard',  role:'prey',      count:[4,8], speed:1.5, fearful:true,  color:5 },
  ],
  ocean: [
    { id:'shark',   shape:'ü¶à', name:'Great White',  role:'apex',      count:[1,2], speed:1.8, fearful:false, color:0 },
    { id:'whale',   shape:'üêã', name:'Blue Whale',   role:'herbivore', count:[1,2], speed:0.6, fearful:false, color:1 },
    { id:'fish',    shape:'üêü', name:'Tuna School',  role:'prey',      count:[8,15],speed:1.6, fearful:true,  color:2 },
    { id:'dolphin', shape:'üê¨', name:'Dolphin',      role:'predator',  count:[3,6], speed:1.7, fearful:false, color:3 },
    { id:'octopus', shape:'üêô', name:'Octopus',      role:'predator',  count:[2,4], speed:1.1, fearful:false, color:4 },
    { id:'turtle',  shape:'üê¢', name:'Sea Turtle',   role:'herbivore', count:[2,5], speed:0.5, fearful:false, color:5 },
  ],
  jungle: [
    { id:'tiger',   shape:'üêÖ', name:'Bengal Tiger', role:'apex',      count:[1,2], speed:1.6, fearful:false, color:0 },
    { id:'monkey',  shape:'üêí', name:'Macaque',      role:'herbivore', count:[5,10],speed:1.4, fearful:true,  color:1 },
    { id:'snake',   shape:'üêç', name:'Python',       role:'predator',  count:[2,4], speed:0.8, fearful:false, color:2 },
    { id:'parrot',  shape:'ü¶ú', name:'Macaw',        role:'prey',      count:[4,8], speed:1.2, fearful:true,  color:3 },
    { id:'panther', shape:'üêÜ', name:'Panther',      role:'predator',  count:[1,3], speed:1.7, fearful:false, color:4 },
    { id:'frog',    shape:'üê∏', name:'Tree Frog',    role:'prey',      count:[6,12],speed:0.9, fearful:true,  color:5 },
  ],
  arctic: [
    { id:'pbear',   shape:'üêª', name:'Polar Bear',   role:'apex',      count:[1,2], speed:1.1, fearful:false, color:0 }, // Use Bear Head or 'ü¶≠'
    { id:'penguin', shape:'üêß', name:'Penguin',      role:'prey',      count:[6,12],speed:0.8, fearful:true,  color:1 },
    { id:'seal',    shape:'ü¶≠', name:'Seal',         role:'prey',      count:[4,8], speed:1.2, fearful:true,  color:2 },
    { id:'wolf_a',  shape:'üêï', name:'Arctic Wolf',  role:'predator',  count:[2,4], speed:1.5, fearful:false, color:3 },
    { id:'owl_a',   shape:'ü¶â', name:'Snowy Owl',    role:'predator',  count:[1,2], speed:1.4, fearful:false, color:4 },
    { id:'fox_a',   shape:'ü¶ä', name:'Arctic Fox',   role:'prey',      count:[3,6], speed:1.3, fearful:true,  color:5 },
  ],
  volcanic: [
    { id:'salamander', shape:'ü¶é', name:'Fire Newt',  role:'predator',  count:[3,6], speed:1.0, fearful:false, color:0 },
    { id:'crab',       shape:'ü¶Ä', name:'Lava Crab',  role:'herbivore', count:[4,8], speed:0.8, fearful:false, color:1 },
    { id:'bat',        shape:'ü¶á', name:'Cave Bat',   role:'prey',      count:[8,15],speed:1.6, fearful:true,  color:2 },
  ],
};

// ‚îÄ‚îÄ ALIEN CREATURE DEFINITIONS PER BIOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BIOME_CREATURES = {
  temperate: [
    { id:'threll',  shape:'threll', name:'Threll',   role:'herbivore', count:[3,6], speed:1.2, fearful:true,  color:0 },
    { id:'velkor',  shape:'velkor', name:'Vel-Kor',   role:'predator',  count:[1,3], speed:1.5, fearful:false, color:1 },
    { id:'orrath',  shape:'orrath', name:'Orrath',    role:'apex',      count:[1,2], speed:1.0, fearful:false, color:2 },
    { id:'sylph',   shape:'sylph',  name:'Sylph',     role:'prey',      count:[4,8], speed:1.8, fearful:true,  color:3 },
    { id:'kethis',  shape:'kethis', name:'Keth-is',   role:'predator',  count:[2,4], speed:1.4, fearful:false, color:4 },
    { id:'zhaun',   shape:'zhaun',  name:'Zhaun',     role:'predator',  count:[1,3], speed:1.1, fearful:false, color:5 },
  ],
  desert: [
    { id:'kethis',  shape:'kethis', name:'Kel-Tharis', role:'predator',  count:[2,5], speed:0.9, fearful:false, color:0 },
    { id:'threll',  shape:'threll', name:'Dura-Threll', role:'herbivore', count:[2,4], speed:0.8, fearful:false, color:1 },
    { id:'draxis',  shape:'draxis', name:'Drax-is',    role:'apex',      count:[2,4], speed:0.7, fearful:false, color:2 },
    { id:'neth',    shape:'neth',   name:'Nethara',    role:'prey',      count:[4,7], speed:1.5, fearful:true,  color:3 },
    { id:'skrave',  shape:'skrave', name:'Skrave',     role:'predator',  count:[1,2], speed:1.6, fearful:false, color:4 },
    { id:'sylph',   shape:'sylph',  name:'Dust-Sylph', role:'prey',      count:[3,6], speed:1.3, fearful:true,  color:5 },
  ],
  ocean: [
    { id:'velkor',  shape:'velkor', name:'Vel-Naur',   role:'predator',  count:[2,5], speed:1.8, fearful:false, color:0 },
    { id:'orrath',  shape:'orrath', name:'Rath-Oma',   role:'apex',      count:[1,2], speed:0.7, fearful:false, color:1 },
    { id:'sylph',   shape:'sylph',  name:'Aqu-Sylph',  role:'prey',      count:[5,9], speed:1.4, fearful:true,  color:2 },
    { id:'vorrn',   shape:'vorrn',  name:'Vorrn',      role:'herbivore', count:[3,6], speed:0.8, fearful:false, color:3 },
    { id:'draxis',  shape:'draxis', name:'Drak-Naur',  role:'apex',      count:[1,3], speed:1.6, fearful:false, color:4 },
    { id:'neth',    shape:'neth',   name:'Nethis',     role:'herbivore', count:[2,4], speed:0.5, fearful:false, color:5 },
  ],
  jungle: [
    { id:'threll',  shape:'threll', name:'Grel-Thon',  role:'herbivore', count:[3,6], speed:1.5, fearful:true,  color:0 },
    { id:'vexar',   shape:'vexar',  name:'Vex-Arrak',  role:'apex',      count:[1,2], speed:1.7, fearful:false, color:1 },
    { id:'zhaun',   shape:'zhaun',  name:'Zhaunari',   role:'prey',      count:[4,7], speed:1.4, fearful:true,  color:2 },
    { id:'kethis',  shape:'kethis', name:'Ker-Thiss',  role:'predator',  count:[2,4], speed:0.9, fearful:false, color:3 },
    { id:'orrath',  shape:'orrath', name:'Gorrath',    role:'herbivore', count:[1,3], speed:0.9, fearful:false, color:4 },
    { id:'sylph',   shape:'sylph',  name:'Lum-Sylph',  role:'prey',      count:[4,8], speed:1.1, fearful:true,  color:5 },
  ],
  arctic: [
    { id:'orrath',  shape:'orrath', name:'Keld-Orra',  role:'apex',      count:[1,2], speed:1.0, fearful:false, color:0 },
    { id:'vorrn',   shape:'vorrn',  name:'Vorn-Isk',   role:'prey',      count:[3,6], speed:1.0, fearful:true,  color:1 },
    { id:'sylph',   shape:'sylph',  name:'Cryo-Sylph', role:'prey',      count:[4,8], speed:0.9, fearful:true,  color:2 },
    { id:'velkor',  shape:'velkor', name:'Vel-Krath',  role:'predator',  count:[1,3], speed:1.4, fearful:false, color:3 },
    { id:'neth',    shape:'neth',   name:'Ice-Neth',   role:'apex',      count:[1,2], speed:0.7, fearful:false, color:4 },
    { id:'skrave',  shape:'skrave', name:'Skrave-Cyr', role:'predator',  count:[2,4], speed:1.4, fearful:false, color:5 },
  ],
  volcanic: [
    { id:'draxis',  shape:'draxis', name:'Pyraxis',    role:'apex',      count:[1,2], speed:1.3, fearful:false, color:0 },
    { id:'kethis',  shape:'kethis', name:'Mag-Keth',   role:'predator',  count:[2,5], speed:1.2, fearful:false, color:1 },
    { id:'skrave',  shape:'skrave', name:'Cinder-Skrave',role:'prey',    count:[4,8], speed:1.6, fearful:true,  color:2 },
    { id:'zhaun',   shape:'zhaun',  name:'Ember-Zhaun',role:'prey',      count:[5,9], speed:1.0, fearful:true,  color:3 },
    { id:'threll',  shape:'threll', name:'Scorch-Threll',role:'herbivore',count:[2,5],speed:1.1, fearful:false, color:4 },
    { id:'vexar',   shape:'vexar',  name:'Ash-Vexar',  role:'predator',  count:[2,4], speed:1.5, fearful:false, color:5 },
  ],
  crystal: [
    { id:'threll',  shape:'threll', name:'Kry-Threll', role:'herbivore', count:[2,5], speed:1.1, fearful:true,  color:0 },
    { id:'draxis',  shape:'draxis', name:'Shard-Drax', role:'predator',  count:[2,4], speed:1.3, fearful:false, color:1 },
    { id:'qythe',   shape:'qythe',  name:'Qythe',      role:'prey',      count:[5,9], speed:1.4, fearful:true,  color:2 },
    { id:'velkor',  shape:'velkor', name:'Prism-Vel',  role:'apex',      count:[1,3], speed:1.0, fearful:false, color:3 },
    { id:'sylph',   shape:'sylph',  name:'Shardling',  role:'prey',      count:[4,7], speed:1.7, fearful:true,  color:4 },
    { id:'zhaun',   shape:'zhaun',  name:'Lux-Zhaun',  role:'predator',  count:[1,3], speed:1.1, fearful:false, color:5 },
  ],
  void: [
    { id:'sylph',   shape:'sylph',  name:'Veil-Sylph', role:'prey',      count:[4,8], speed:1.6, fearful:true,  color:0 },
    { id:'skrave',  shape:'skrave', name:'Null-Skrave', role:'predator', count:[2,5], speed:1.4, fearful:false, color:1 },
    { id:'qythe',   shape:'qythe',  name:'Qythe-Maw',  role:'apex',      count:[1,2], speed:1.2, fearful:false, color:2 },
    { id:'zhaun',   shape:'zhaun',  name:'Rift-Zhaun', role:'prey',      count:[5,9], speed:2.0, fearful:true,  color:3 },
    { id:'vexar',   shape:'vexar',  name:'Vex-Null',   role:'predator',  count:[2,4], speed:0.9, fearful:false, color:4 },
    { id:'draxis',  shape:'draxis', name:'Void-Draxis', role:'herbivore',count:[2,4], speed:1.0, fearful:false, color:5 },
  ],
};

// Fallback to temperate if biome unknown
function getCreaturesForBiome(biome) {
  return BIOME_CREATURES[biome] || BIOME_CREATURES.temperate;
}

// Get color for creature def given biome
function getCreatureColor(def, biome) {
  const palette = BIOME_CREATURE_COLORS[biome] || BIOME_CREATURE_COLORS.temperate;
  return palette[def.color % palette.length];
}

// ‚îÄ‚îÄ INTERACTION TEMPLATES ‚Äî alien lore, no emojis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const INTERACTIONS = {
  hunt: (pred, prey) => [
    `<strong>${pred.name}</strong> enters low-resonance phase and converges on a <strong>${prey.name}</strong> cluster.`,
    `<strong>${pred.name}</strong> breaks concealment ‚Äî the <strong>${prey.name}</strong> scatter along divergent vectors!`,
    `The pursuit ends. <strong>${pred.name}</strong> ${Math.random()<0.5 ? `absorbs the quarry's bio-signature` : `loses trace in the thermic layer`}.`
  ],
  graze: (h) => [
    `A <strong>${h.name}</strong> formation drifts across the substrate, cycling nutrient intake.`,
    `<strong>${h.name}</strong> cluster shifts toward the mineral seam ‚Äî pressure-feeding in sequence.`,
    `A lone <strong>${h.name}</strong> emits a low harmonic ‚Äî the group pauses, then resumes drift.`,
  ],
  flee: (prey, pred) => [
    `<strong>${prey.name}</strong> detect trace pheromones of a <strong>${pred.name}</strong> and disperse!`,
    `The <strong>${prey.name}</strong> formation collapses outward ‚Äî emergency dispersal protocol.`,
    `A <strong>${prey.name}</strong> phase-burrows beneath the surface membrane to evade detection.`,
  ],
  social: (a, b) => [
    `Two <strong>${a.name}</strong> exchange bio-luminescent pulses in a recognition display.`,
    `A <strong>${a.name}</strong> and a <strong>${b.name}</strong> orbit each other ‚Äî territorial boundary negotiation.`,
    `<strong>${a.name}</strong> broadcasts a low-frequency signal ‚Äî the surrounding group converges.`,
  ],
  breed: (a) => [
    `A <strong>${a.name}</strong> begins a chromatic resonance display ‚Äî mating cycle initiated.`,
    `Two <strong>${a.name}</strong> fuse briefly into a shared membrane ‚Äî spore dispersal complete.`,
    `Juvenile <strong>${a.name}</strong> emerge from the substrate ‚Äî the cycle continues.`,
  ],
  apex: (a) => [
    `<strong>${a.name}</strong> broadcasts a territorial null-field. All nearby fauna clear the zone.`,
    `The <strong>${a.name}</strong> ascends to the ridge and holds ‚Äî its presence reshapes the local ecology.`,
    `Nothing approaches the <strong>${a.name}</strong>. Its bio-signature blankets the entire area.`,
  ],
  migrate: (a) => [
    `A vast column of <strong>${a.name}</strong> initiates the long-cycle traverse ‚Äî migration has begun.`,
    `<strong>${a.name}</strong> follow sub-surface magnetic gradients carved by millennia of movement.`,
    `The migration of <strong>${a.name}</strong> reshapes the terrain beneath them as they pass.`,
  ],
  disaster: (a) => [
    `Seismic resonance disrupts the substrate ‚Äî <strong>${a.name}</strong> scatter in all directions.`,
    `A pressure wave collapses the thermal layer. <strong>${a.name}</strong> emergency-phase upward.`,
    `In the aftermath, a single <strong>${a.name}</strong> broadcasts a distress harmonic into the silence.`,
  ],
  feed: (a) => [
    `<strong>${a.name}</strong> locates a dense nutrient bloom and initiates rapid cycling.`,
    `Abundance event detected ‚Äî <strong>${a.name}</strong> population density spikes across the zone.`,
    `The <strong>${a.name}</strong> cluster compresses around the source, layering intake vectors.`,
  ],
};

// ‚îÄ‚îÄ PER-CONTINENT CREATURE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// We store creature populations per continent index
const continentCreatures = {};  // contIdx -> [{ def, count, x, y, vx, phase, selected }]

function initContinentCreatures(ws) {
  const source = ws.cfg.ecoMode === 'earth' ? EARTH_CREATURES : BIOME_CREATURES;
  const biomeType = ws.cfg.biome;
  const pool = source[biomeType] || source['temperate'];

  ws.continents.forEach((cont, i) => {
    // 1. Map the pool data to actual creature instances
    const creatures = pool.map(def => ({
      def: def,
      count: randInt(def.count[0], def.count[1]),
      // 2. Position them relative to the CONTINENT'S coordinates (cx, cy)
      // instead of hardcoded 30-570
      x: cont.cx + (Math.random() - 0.5) * (cont.w * 0.7),
      y: cont.cy + (Math.random() - 0.5) * (cont.h * 0.7),
      vx: (Math.random() < 0.5 ? 1 : -1) * (def.speed || 1),
      phase: Math.random() * Math.PI * 2,
    }));

    cont.creatures = creatures;
    continentCreatures[i] = creatures; 
  });
}

// ‚îÄ‚îÄ CREATURE PANEL STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeContinentIdx = null;
let sceneAnimId = null;
let interactionTimer = null;
let selectedCreatureId = null;
let interactionEntries = [];
const MAX_LOG = 8;

function openCreaturePanel(ws, contIdx) {
  activeContinentIdx = contIdx;
  const cont = ws.continents[contIdx];
  // Header
  document.getElementById('cp-continent-name').textContent =
    `Island ${contIdx + 1} ‚Äî ${ws.cfg.biome.charAt(0).toUpperCase() + ws.cfg.biome.slice(1)} Ecosystem`;
  document.getElementById('cp-subtitle').textContent =
    `Click a creature below to focus ¬∑ ${cont.cx|0}¬∞N ${cont.cy|0}¬∞E`;

  buildCreatureRoster(ws, contIdx);
  startCreatureScene(ws, contIdx);
  startInteractionTimer(ws, contIdx);

  document.getElementById('creature-panel').classList.add('visible');
  addInteraction('‚óâ', `Orbital scan targeting landmass ${contIdx + 1}...`, `Yr.${ws.year}`);
  addInteraction('‚óà', `${ws.cfg.name} ecosystem active ‚Äî ${continentCreatures[contIdx].length} species catalogued.`);
}

function closeCreaturePanel() {
  document.getElementById('creature-panel').classList.remove('visible');
  if (sceneAnimId) cancelAnimationFrame(sceneAnimId);
  if (interactionTimer) clearInterval(interactionTimer);
  activeContinentIdx = null;
  selectedCreatureId = null;
  interactionEntries = [];
}

// ‚îÄ‚îÄ ROSTER RENDERING ‚Äî inline SVG preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCreatureRoster(ws, contIdx) {
  const roster = document.getElementById('creature-roster');
  roster.innerHTML = '';
  const creatures = continentCreatures[contIdx] || [];

  creatures.forEach(c => {
    const chip = document.createElement('div');
    // Ensure the chip always gets the class and selected state
    chip.className = 'creature-chip' + (c.def.id === selectedCreatureId ? ' selected' : '');
    chip.dataset.id = c.def.id;

    // --- ICON LOGIC ---
    const isEmoji = !CREATURE_SHAPES[c.def.shape];
    
    if (isEmoji) {
      // Create Emoji Span (styled to match SVG size)
      const emojiSpan = document.createElement('span');
      emojiSpan.style.fontSize = '20px';
      emojiSpan.style.width = '28px';
      emojiSpan.style.height = '28px';
      emojiSpan.style.display = 'flex';
      emojiSpan.style.alignItems = 'center';
      emojiSpan.style.justifyContent = 'center';
      emojiSpan.style.flexShrink = '0';
      emojiSpan.textContent = c.def.shape;
      chip.appendChild(emojiSpan);
    } else {
      // Create Inline SVG icon
      const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      iconSvg.setAttribute('width', '28'); 
      iconSvg.setAttribute('height', '28');
      iconSvg.setAttribute('viewBox', '-16 -16 32 32');
      iconSvg.style.flexShrink = '0';
      
      const color = getCreatureColor(c.def, ws.cfg.biome);
      const drawFn = CREATURE_SHAPES[c.def.shape] || CREATURE_SHAPES['zhaun'];
      drawFn(iconSvg, 0, 0, 10, color);
      chip.appendChild(iconSvg);
    }

    // --- TEXT LOGIC ---
    const nameSpan = document.createElement('span');
    nameSpan.className = 'cc-name'; 
    nameSpan.textContent = c.def.name;
    chip.appendChild(nameSpan);

    const countBadge = document.createElement('span');
    countBadge.className = 'cc-count'; 
    countBadge.textContent = `√ó${c.count}`; // Added √ó for better UI
    chip.appendChild(countBadge);

    // --- CLICK LOGIC ---
    chip.addEventListener('click', () => {
      selectedCreatureId = selectedCreatureId === c.def.id ? null : c.def.id;
      buildCreatureRoster(ws, contIdx); // Refresh UI
      
      const msg = selectedCreatureId
        ? `Locking bio-scan on <strong>${c.def.name}</strong> ‚Äî ${c.def.role} class.`
        : `Scanning full ecosystem ‚Äî all species tracked.`;
      addInteraction('‚óà', msg);
    });
    
    roster.appendChild(chip);
  });
}
// ‚îÄ‚îÄ INTERACTION LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addInteraction(emoji, text, time = '') {
  interactionEntries.unshift({ emoji, text, time });
  if (interactionEntries.length > MAX_LOG) interactionEntries.pop();
  const container = document.getElementById('interaction-entries');
  container.innerHTML = '';
  interactionEntries.forEach(e => {
    const div = document.createElement('div');
    div.className = 'interaction-entry';
    div.innerHTML = `
      <span class="ie-emoji">${e.emoji}</span>
      <span class="ie-text">${e.text}${e.time ? `<span class="ie-time">${e.time}</span>` : ''}</span>
    `;
    container.appendChild(div);
  });
}

// ‚îÄ‚îÄ INTERACTION TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startInteractionTimer(ws, contIdx) {
  if (interactionTimer) clearInterval(interactionTimer);
  interactionTimer = setInterval(() => {
    if (activeContinentIdx === null) return;
    generateRandomInteraction(ws, contIdx);
  }, 3500);
}

function generateRandomInteraction(ws, contIdx, forcedType = null) {
  const creatures = continentCreatures[contIdx] || [];
  if (!creatures.length) return;

  const alive = creatures.filter(c => c.count > 0);
  if (!alive.length) return;

  // If a creature is selected, bias toward it
  const focused = selectedCreatureId ? alive.find(c => c.def.id === selectedCreatureId) : null;
  const actor = focused || alive[randInt(0, alive.length - 1)];
  const type = forcedType || pickInteractionType(actor.def, alive);

  let lines, emoji;

  if (type === 'hunt') {
    const prey = alive.find(c => c.def.role === 'prey' || c.def.role === 'herbivore');
    if (!prey) { generateRandomInteraction(ws, contIdx, 'apex'); return; }
    lines = INTERACTIONS.hunt(actor.def, prey.def);
    emoji = '‚öîÔ∏è';
    // Occasionally reduce prey count
    if (Math.random() < 0.3 && prey.count > 1) {
      prey.count--;
      buildCreatureRoster(ws, contIdx);
    }
  } else if (type === 'flee') {
    const pred = alive.find(c => c.def.role === 'predator' || c.def.role === 'apex');
    if (!pred) { generateRandomInteraction(ws, contIdx, 'graze'); return; }
    lines = INTERACTIONS.flee(actor.def, pred.def);
    emoji = 'üí®';
  } else if (type === 'breed') {
    lines = INTERACTIONS.breed(actor.def);
    emoji = 'üíï';
    if (Math.random() < 0.4) {
      actor.count = Math.min(actor.count + 1, actor.def.count[1] + 3);
      buildCreatureRoster(ws, contIdx);
    }
  } else if (type === 'social') {
    const partner = alive[randInt(0, alive.length - 1)];
    lines = INTERACTIONS.social(actor.def, partner.def);
    emoji = 'ü§ù';
  } else if (type === 'apex') {
    lines = INTERACTIONS.apex(actor.def);
    emoji = 'üëë';
  } else if (type === 'graze') {
    lines = INTERACTIONS.graze(actor.def);
    emoji = 'üåø';
  } else {
    lines = INTERACTIONS.graze(actor.def);
    emoji = 'üåø';
  }

  const line = lines[randInt(0, lines.length - 1)];
  addInteraction(emoji, line, `Yr.${ws.year}`);
  triggerSceneEvent(type, actor);
}

function pickInteractionType(def, alive) {
  const hasPrey = alive.some(c => c.def.role === 'prey' || c.def.role === 'herbivore');
  if (def.role === 'predator' && hasPrey && Math.random() < 0.45) return 'hunt';
  if (def.role === 'apex' && Math.random() < 0.35) return 'apex';
  if (def.role === 'prey' && Math.random() < 0.35) return 'flee';
  if (Math.random() < 0.2) return 'breed';
  if (Math.random() < 0.3) return 'social';
  return 'graze';
}

// ‚îÄ‚îÄ ANIMATED SCENE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sceneCreatureSprites = [];

function startCreatureScene(ws, contIdx) {
  if (sceneAnimId) cancelAnimationFrame(sceneAnimId);
  const svg = document.getElementById('creature-scene-svg');
  svg.innerHTML = '';
  const SW = document.getElementById('creature-card')?.clientWidth || svg.clientWidth || 640;
  const SH = 190;
  svg.setAttribute('viewBox', `0 0 ${SW} ${SH}`);

  const pal = BIOME_PALETTES[ws.cfg.biome] || BIOME_PALETTES.temperate;

  // Background
  const bgG = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  svg.appendChild(bgG);
  const sceneGrad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  sceneGrad.setAttribute('id', 'scene-sky'); sceneGrad.setAttribute('x1','0'); sceneGrad.setAttribute('y1','0');
  sceneGrad.setAttribute('x2','0'); sceneGrad.setAttribute('y2','1');
  const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s1.setAttribute('offset','0%'); s1.setAttribute('stop-color', pal.sky || '#0a1a0d');
  const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s2.setAttribute('offset','100%'); s2.setAttribute('stop-color', pal.ocean[0]);
  sceneGrad.appendChild(s1); sceneGrad.appendChild(s2); bgG.appendChild(sceneGrad);

  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',SW); bg.setAttribute('height',SH);
  bg.setAttribute('fill','url(#scene-sky)'); svg.appendChild(bg);

  // Stars (small, subtle)
  for (let i = 0; i < 30; i++) {
    const star = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    star.setAttribute('cx', rand(0, SW)); star.setAttribute('cy', rand(0, SH * 0.6));
    star.setAttribute('r', rand(0.4, 1.2)); star.setAttribute('fill', 'rgba(255,255,255,0.4)');
    svg.appendChild(star);
  }

  // Ground strip
  const groundColor = pal.land[0] || '#3d7a3a';
  const groundRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  groundRect.setAttribute('x',0); groundRect.setAttribute('y', SH - 45);
  groundRect.setAttribute('width', SW); groundRect.setAttribute('height', 45);
  groundRect.setAttribute('fill', groundColor); groundRect.setAttribute('opacity','0.8');
  svg.appendChild(groundRect);

  // Ground highlight line
  const gLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  gLine.setAttribute('x1',0); gLine.setAttribute('y1', SH - 45);
  gLine.setAttribute('x2', SW); gLine.setAttribute('y2', SH - 45);
  gLine.setAttribute('stroke','rgba(255,255,255,0.12)'); gLine.setAttribute('stroke-width','1');
  svg.appendChild(gLine);

  // Background alien vegetation
  const creatures = continentCreatures[contIdx] || [];
  const groundColorDark = pal.land[1] || pal.land[0];
  const vegCount = 10;
  for (let i = 0; i < vegCount; i++) {
    const vx = rand(15, SW - 15);
    const vy = SH - 45;
    const vegH = rand(18, 52);
    const vtype = randInt(0, 4);
    if (vtype === 0) {
      svgEl('polygon', {points:`${vx},${vy-vegH} ${vx-vegH*0.18},${vy} ${vx+vegH*0.18},${vy}`, fill:groundColorDark, opacity:'0.5'}, svg);
    } else if (vtype === 1) {
      svgEl('line', {x1:vx,y1:vy,x2:vx,y2:vy-vegH*0.65,stroke:groundColorDark,'stroke-width':vegH*0.09,'stroke-linecap':'round',opacity:'0.45'}, svg);
      svgEl('ellipse', {cx:vx,cy:vy-vegH,rx:vegH*0.22,ry:vegH*0.3,fill:groundColorDark,opacity:'0.4'}, svg);
    } else if (vtype === 2) {
      svgEl('path', {d:`M${vx},${vy} L${vx-vegH*0.4},${vy-vegH*0.85} M${vx},${vy} L${vx},${vy-vegH} M${vx},${vy} L${vx+vegH*0.4},${vy-vegH*0.85}`,stroke:groundColorDark,'stroke-width':vegH*0.1,fill:'none',opacity:'0.45','stroke-linecap':'round'}, svg);
    } else if (vtype === 3) {
      for (let b=0;b<3;b++) svgEl('circle',{cx:vx+rand(-vegH*0.2,vegH*0.2),cy:vy-vegH*rand(0.4,0.9),r:vegH*0.14,fill:groundColorDark,opacity:'0.38'},svg);
    } else {
      svgEl('ellipse',{cx:vx,cy:vy-vegH*0.15,rx:vegH*0.45,ry:vegH*0.22,fill:groundColorDark,opacity:'0.35'},svg);
    }
  }

  const spriteGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  spriteGroup.setAttribute('id', 'creature-sprites');
  svg.appendChild(spriteGroup);

  const fxGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  fxGroup.setAttribute('id', 'creature-fx');
  svg.appendChild(fxGroup);

  // Spawn creature sprites (UPDATED FOR EMOJI SUPPORT)
  sceneCreatureSprites = [];
  creatures.forEach((c, ci) => {
    const visible = Math.min(c.count, 3);
    const color = getCreatureColor(c.def, ws.cfg.biome);
    
    // Check if the shape is a key in CREATURE_SHAPES; if not, treat as Emoji
    const isEmoji = !CREATURE_SHAPES[c.def.shape];

    for (let j = 0; j < visible; j++) {
      const sz = c.def.role === 'apex' ? 14 : c.def.role === 'predator' ? 11 : 8;
      const sprite = {
        def: c.def, color,
        x: rand(40, SW - 40),
        y: SH - 48 - rand(0, 10),
        vx: (Math.random() < 0.5 ? 1 : -1) * c.def.speed * 28,
        phase: rand(0, Math.PI * 2),
        size: sz,
        el: null,
        scaleX: 1,
      };

      let g;
      if (isEmoji) {
        // Create SVG text element for Emoji
        g = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        g.textContent = c.def.shape;
        g.setAttribute('font-size', (sz * 2.5) + 'px');
        g.setAttribute('text-anchor', 'middle');
        g.setAttribute('dominant-baseline', 'central');
        spriteGroup.appendChild(g);
      } else {
        // Create G element for Procedural SVG
        g = svgEl('g', {}, spriteGroup);
        const drawFn = CREATURE_SHAPES[c.def.shape] || CREATURE_SHAPES['zhaun'];
        drawFn(g, 0, 0, sz, color);
      }

      g.style.cursor = 'pointer';
      g.style.userSelect = 'none';
      g.addEventListener('click', (ev) => {
        ev.stopPropagation();
        selectedCreatureId = selectedCreatureId === c.def.id ? null : c.def.id;
        buildCreatureRoster(ws, contIdx);
        addInteraction('‚óà', `Locking scan on <strong>${c.def.name}</strong> ‚Äî ${c.def.role} class.`);
      });
      
      sprite.el = g;
      sceneCreatureSprites.push(sprite);
    }
  });

  // Run animation
  let lastT = 0;
  function animateScene(ts) {
    const dt = Math.min((ts - lastT) / 1000, 0.05);
    lastT = ts;
    sceneCreatureSprites.forEach(s => {
      s.phase += dt * 2.2;
      const bob = Math.sin(s.phase) * 2.5;
      s.x += s.vx * dt;
      if (s.x < 30)      { s.x = 30;      s.vx =  Math.abs(s.vx); s.scaleX =  1; }
      if (s.x > SW - 30) { s.x = SW - 30; s.vx = -Math.abs(s.vx); s.scaleX = -1; }
      
      if (Math.random() < 0.003)
        s.vx = (Math.random() < 0.5 ? 1 : -1) * s.def.speed * (22 + rand(0,14));
      
      const isSelected = s.def.id === selectedCreatureId;
      const scale = isSelected ? 1.4 : 1.0;
      
      s.el.setAttribute('transform',
        `translate(${s.x},${s.y + bob}) scale(${s.scaleX * scale},${scale})`);
      s.el.setAttribute('opacity', isSelected ? '1' : selectedCreatureId ? '0.45' : '1');
    });
    sceneAnimId = requestAnimationFrame(animateScene);
  }
  sceneAnimId = requestAnimationFrame(animateScene);
}

// ‚îÄ‚îÄ SCENE PARTICLE FX ‚Äî SVG geometry, no emojis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FX_COLORS = {
  hunt:    ['#ff4444','#ff8800','#ffdd00'],
  flee:    ['#88ddff','#aaeeff','#ffffff'],
  breed:   ['#ff88cc','#ffaaee','#cc88ff'],
  social:  ['#88ffcc','#aaffee','#88ddff'],
  apex:    ['#ffdd00','#ff8800','#ffffff'],
  graze:   ['#88ff99','#aaffbb','#ddffcc'],
  migrate: ['#ffcc88','#ffaa66','#ff8844'],
  disaster:['#ff4444','#ff7700','#88aaff'],
  feed:    ['#aaffaa','#88ff88','#ffeeaa'],
};

function spawnSVGParticle(fxGroup, cx, cy, color, shape) {
  let el;
  if (shape === 'burst') {
    el = svgEl('circle', { cx: cx + rand(-15,15), cy: cy - 8, r: rand(2,5), fill: color, opacity: '1' }, fxGroup);
  } else if (shape === 'ring') {
    el = svgEl('circle', { cx: cx, cy: cy - 8, r: 4, fill: 'none', stroke: color, 'stroke-width': '2', opacity: '1' }, fxGroup);
  } else if (shape === 'shard') {
    const sx = cx + rand(-12,12), sy = cy - rand(4,16);
    el = svgEl('polygon', { points: `${sx},${sy-6} ${sx+4},${sy+4} ${sx-4},${sy+4}`, fill: color, opacity: '1' }, fxGroup);
  } else {
    el = svgEl('line', { x1: cx, y1: cy - 5, x2: cx + rand(-8,8), y2: cy - rand(10,20), stroke: color, 'stroke-width': '2', 'stroke-linecap': 'round', opacity: '1' }, fxGroup);
  }
  const dx = rand(-1.5, 1.5), startY = parseFloat(el.getAttribute('cy') || el.getAttribute('y1') || cy);
  let op = 1, frame = 0;
  const anim = setInterval(() => {
    frame++;
    op -= 0.045;
    const yShift = -frame * 1.2;
    if (shape === 'ring') { el.setAttribute('r', 4 + frame * 0.8); }
    el.setAttribute('opacity', Math.max(0, op));
    try {
      if (shape === 'burst') { el.setAttribute('cy', parseFloat(el.getAttribute('cy')) + yShift * 0.1 - 0.8); el.setAttribute('cx', parseFloat(el.getAttribute('cx')) + dx); }
      else if (shape === 'shard') { el.setAttribute('transform', `translate(${dx * frame * 0.3},${yShift * 0.08})`); }
      else if (shape === 'line')  { el.setAttribute('y2', parseFloat(el.getAttribute('y2')) - 1); }
    } catch(e) {}
    if (op <= 0) { clearInterval(anim); el.remove(); }
  }, 35);
}

function triggerSceneEvent(type, actorCreature) {
  const fxGroup = document.getElementById('creature-fx');
  if (!fxGroup) return;
  const sprite = sceneCreatureSprites.find(s => s.def.id === actorCreature.def.id);
  const cx = sprite ? sprite.x : rand(100, 540);
  const cy = sprite ? sprite.y - 10 : 120;
  const colors = FX_COLORS[type] || ['#ffffff'];
  const shapes = {
    hunt:    ['shard','shard','burst'],
    flee:    ['line','line','line'],
    breed:   ['ring','burst','burst'],
    social:  ['ring','line','burst'],
    apex:    ['shard','shard','ring'],
    graze:   ['burst','line','burst'],
    migrate: ['line','shard','line'],
    disaster:['shard','shard','burst'],
    feed:    ['burst','burst','ring'],
  }[type] || ['burst'];
  const count = type === 'hunt' || type === 'disaster' ? 6 : 3;
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const color = colors[i % colors.length];
      const shape = shapes[i % shapes.length];
      spawnSVGParticle(fxGroup, cx + rand(-10,10), cy + rand(-5,5), color, shape);
    }, i * 60);
  }
}

// ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wireCreatureActions(ws) {
  // Clone buttons to remove any previously attached listeners
  ['btn-feed','btn-migrate','btn-breed','btn-predator','btn-disaster'].forEach(id => {
    const old = document.getElementById(id);
    const clone = old.cloneNode(true);
    old.parentNode.replaceChild(clone, old);
  });
  document.getElementById('btn-feed').addEventListener('click', () => {
    if (activeContinentIdx === null) return;
    const creatures = continentCreatures[activeContinentIdx] || [];
    creatures.forEach(c => { c.count = Math.min(c.count + randInt(1,2), c.def.count[1] + 5); });
    buildCreatureRoster(ws, activeContinentIdx);
    const c = creatures[randInt(0, creatures.length - 1)];
    const lines = INTERACTIONS.feed(c.def);
    addInteraction('‚Üë', lines[randInt(0, lines.length - 1)], `Yr.${ws ? ws.year : ''}`);
    triggerSceneEvent('feed', { def: c.def });
    logEvent(ws, `A nutrient bloom event on Island ${activeContinentIdx + 1} boosts fauna populations!`, 'peace');
  });

  document.getElementById('btn-migrate').addEventListener('click', () => {
    if (activeContinentIdx === null) return;
    const creatures = continentCreatures[activeContinentIdx] || [];
    const c = creatures[randInt(0, creatures.length - 1)];
    const lines = INTERACTIONS.migrate(c.def);
    addInteraction('‚Üí', lines[randInt(0, lines.length - 1)], `Yr.${ws ? ws.year : ''}`);
    triggerSceneEvent('migrate', { def: c.def });
    // Shake sprites briefly
    sceneCreatureSprites.forEach(s => { s.vx = (Math.random() < 0.5 ? 1 : -1) * s.def.speed * 60; });
    logEvent(ws, `Migration cycle on Island ${activeContinentIdx + 1}!`, 'culture');
  });

  document.getElementById('btn-breed').addEventListener('click', () => {
    if (activeContinentIdx === null) return;
    const creatures = continentCreatures[activeContinentIdx] || [];
    creatures.forEach(c => { if (Math.random() < 0.6) c.count += randInt(0,2); });
    buildCreatureRoster(ws, activeContinentIdx);
    const c = creatures[randInt(0, creatures.length - 1)];
    const lines = INTERACTIONS.breed(c.def);
    addInteraction('‚óé', lines[randInt(0, lines.length - 1)], `Yr.${ws ? ws.year : ''}`);
    triggerSceneEvent('breed', { def: c.def });
    logEvent(ws, `Mating season on Island ${activeContinentIdx + 1}! Population increases.`, 'peace');
  });

  document.getElementById('btn-predator').addEventListener('click', () => {
    if (activeContinentIdx === null) return;
    const creatures = continentCreatures[activeContinentIdx] || [];
    const prey = creatures.filter(c => c.def.role === 'prey' && c.count > 0);
    prey.forEach(p => { if (Math.random() < 0.5) p.count = Math.max(1, p.count - randInt(1,3)); });
    buildCreatureRoster(ws, activeContinentIdx);
    addInteraction('‚úï', `An apex entity arrives on Island ${activeContinentIdx + 1}! Prey-class organisms scatter.`, `Yr.${ws ? ws.year : ''}`);
    sceneCreatureSprites.filter(s => s.def.fearful).forEach(s => {
      s.vx = (Math.random() < 0.5 ? 1 : -1) * s.def.speed * 80;
    });
    triggerSceneEvent('hunt', creatures[0] || { def: creatures[0]?.def });
    logEvent(ws, `Apex entity detected on landmass ${activeContinentIdx + 1}!`, 'war');
  });

  document.getElementById('btn-disaster').addEventListener('click', () => {
    if (activeContinentIdx === null) return;
    const creatures = continentCreatures[activeContinentIdx] || [];
    creatures.forEach(c => { if (Math.random() < 0.5) c.count = Math.max(1, c.count - randInt(1,2)); });
    buildCreatureRoster(ws, activeContinentIdx);
    const c = creatures[randInt(0, creatures.length - 1)];
    const lines = INTERACTIONS.disaster(c.def);
    addInteraction('~', lines[randInt(0, lines.length - 1)], `Yr.${ws ? ws.year : ''}`);
    sceneCreatureSprites.forEach(s => { s.vx = (Math.random() < 0.5 ? 1 : -1) * s.def.speed * 100; });
    triggerSceneEvent('disaster', { def: c.def });
    logEvent(ws, `Natural disaster strikes Island ${activeContinentIdx + 1}! üåä`, 'war');
  });
}

// ‚îÄ‚îÄ CLOSE BUTTON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('close-creature-panel').addEventListener('click', closeCreaturePanel);
document.getElementById('creature-backdrop').addEventListener('click', closeCreaturePanel);

// ‚îÄ‚îÄ MAKE CONTINENTS CLICKABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// initContinentCreatures, addContinentClickZones, wireCreatureActions
// are called from inside buildWorld via setTimeout (see above).

function addContinentClickZones(ws) {
  const svg = ws.svg;
  // Re-use the 'ui-svg' layer for click zones (sits on top)
  const layer = ws.layers['ui-svg'];

  ws.continents.forEach((cont, i) => {
    const ptStr = cont.pts.map(p => p.join(',')).join(' ');

    // Invisible hit area polygon
    const hitZone = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    hitZone.setAttribute('points', ptStr);
    hitZone.setAttribute('fill', 'transparent');
    hitZone.setAttribute('stroke', 'transparent');
    hitZone.setAttribute('stroke-width', '10');
    hitZone.style.cursor = 'pointer';
    hitZone.dataset.contIdx = i;

    // Hover highlight
    hitZone.addEventListener('mouseenter', () => {
      hitZone.setAttribute('fill', 'rgba(58,159,255,0.08)');
      hitZone.setAttribute('stroke', 'rgba(58,159,255,0.3)');
      hitZone.setAttribute('stroke-width', '2');
    });
    hitZone.addEventListener('mouseleave', () => {
      hitZone.setAttribute('fill', 'transparent');
      hitZone.setAttribute('stroke', 'transparent');
    });
    hitZone.addEventListener('click', (ev) => {
      ev.stopPropagation();
      interactionEntries = [];
      openCreaturePanel(ws, i);
    });
    layer.appendChild(hitZone);

    // Small hint label at continent center
    const hint = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    hint.setAttribute('x', cont.cx); hint.setAttribute('y', cont.cy + cont.h * 0.45);
    hint.setAttribute('text-anchor', 'middle');
    hint.setAttribute('font-size', '7');
    hint.setAttribute('fill', 'rgba(255,255,255,0.22)');
    hint.setAttribute('font-family', 'Space Mono,monospace');
    hint.setAttribute('letter-spacing', '1.5');
    hint.setAttribute('pointer-events', 'none');
    hint.textContent = '[ click ]';
    layer.appendChild(hint);
  });
}

async function captureAndShare() {
  const svg = document.getElementById('world-svg');
  if (!svg) return;

  addInteraction('‚óà', 'Initializing high-res orbital photography...');

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  const dpr = 2; 
  const bounds = svg.getBoundingClientRect();
  const footerHeight = 60; // Extra space for the branding
  
  // Increase height to accommodate the footer bar
  canvas.width = bounds.width * dpr;
  canvas.height = (bounds.height + footerHeight) * dpr;
  ctx.scale(dpr, dpr);

  const svgData = new XMLSerializer().serializeToString(svg);
  const img = new Image();
  const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);

  img.onload = async () => {
    // 1. Fill background (Black space)
    ctx.fillStyle = '#070a0f';
    ctx.fillRect(0, 0, bounds.width, bounds.height + footerHeight);
    
    // 2. Draw the Planet
    ctx.drawImage(img, 0, 0, bounds.width, bounds.height);
    URL.revokeObjectURL(url);

    // 3. Draw Footer Branding
    const footerY = bounds.height;
    
    // Suble background for the footer bar
    ctx.fillStyle = 'rgba(123, 95, 255, 0.15)';
    ctx.fillRect(0, footerY, bounds.width, footerHeight);
    
    // Top border for the footer
    ctx.strokeStyle = 'rgba(123, 95, 255, 0.3)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(0, footerY);
    ctx.lineTo(bounds.width, footerY);
    ctx.stroke();

    // Text Credits
    ctx.fillStyle = '#7b5fff';
    ctx.font = "bold 11px 'Space Mono', monospace";
    ctx.fillText("SOURCE UPLINK:", 20, footerY + 35);
    
    ctx.fillStyle = '#fff';
    ctx.font = "11px 'Space Mono', monospace";
    ctx.fillText("coyoteke.com/GameEngineForPlanets/genWorld.html", 125, footerY + 35);

    ctx.textAlign = "right";
    ctx.fillStyle = 'rgba(200, 216, 238, 0.4)';
    ctx.font = "9px 'Space Mono', monospace";
    ctx.fillText("GENWORLD ORBITAL SNAPSHOT v3.0", bounds.width - 20, footerY + 35);
    ctx.textAlign = "left"; // Reset alignment

    // 4. Convert to File and Share
    canvas.toBlob(async (blob) => {
      const fileName = `${worldState.cfg.name.replace(/\s+/g, '_')}_planet.png`;
      const file = new File([blob], fileName, { type: 'image/png' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: `Check out my planet: ${worldState.cfg.name}`,
            text: `I just generated this ${worldState.cfg.biome} world in genWorld!`,
          });
          addInteraction('‚óà', 'Transmission shared across the galactic net.');
        } catch (e) {
          console.log('Share cancelled');
        }
      } else {
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
        addInteraction('‚óà', 'Snapshot saved to local datastream.');
      }
    }, 'image/png');
  };

  img.src = url;
}
async function exportCreaturePNG() {
  const svg = document.getElementById('creature-scene-svg');
  const btn = (window.event && window.event.currentTarget) || document.querySelector('.btn-share');
  
  if (!svg) return;

  const originalText = btn.innerHTML;
  btn.innerHTML = "<span>‚è≥</span> EXPORTING...";
  btn.style.opacity = "0.5";
  btn.style.pointerEvents = "none";

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const dpr = 2; 
  const w = 560; 
  const h = 880; // Slightly taller to fit the URL comfortably
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);

  const svgData = new XMLSerializer().serializeToString(svg);
  const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);
  const sceneImg = new Image();

  sceneImg.onload = () => {
    // 1. BACKGROUND & FRAME
    ctx.fillStyle = '#0a0f16';
    ctx.fillRect(0, 0, w, h);
    
    const grad = ctx.createLinearGradient(0, 0, w, h);
    grad.addColorStop(0, '#3a9fff');
    grad.addColorStop(1, '#7b5fff');
    ctx.strokeStyle = grad;
    ctx.lineWidth = 3;
    ctx.strokeRect(10, 10, w - 20, h - 20);

    // 2. SCENE DRAWING
    const targetW = w - 40;
    const targetH = 220;
    const imgRatio = sceneImg.width / sceneImg.height;
    const drawW = targetW;
    const drawH = targetW / imgRatio;
    ctx.fillStyle = '#000';
    ctx.fillRect(20, 25, targetW, targetH);
    ctx.drawImage(sceneImg, 20, 25 + (targetH - drawH) / 2, drawW, drawH);
    URL.revokeObjectURL(url);

    // 3. TEXT DATA
    const creature = selectedCreatureId 
      ? worldState.continents.flatMap(c => c.creatures).find(c => c.def.id === selectedCreatureId)
      : null;

    ctx.fillStyle = '#fff';
    ctx.font = "bold 24px Syne, sans-serif";
    ctx.fillText(creature ? creature.def.name.toUpperCase() : "ECOSYSTEM OVERVIEW", 25, 285);

    ctx.fillStyle = '#3a9fff';
    ctx.font = "10px 'Space Mono', monospace";
    ctx.fillText(creature ? "SPECIMEN DATA ACTIVE" : "WIDE-BAND PLANETARY SCAN", 25, 305);

    ctx.fillStyle = 'rgba(58, 159, 255, 0.08)';
    ctx.fillRect(25, 325, w - 50, 140);
    ctx.fillStyle = '#c8d8ee';
    ctx.font = "13px 'Space Mono', monospace";

    const stats = creature ? [
        `ROLE: ${creature.def.role.toUpperCase()}`,
        `POPULATION: ${creature.count} UNITS`,
        `LOCOMOTION: ${creature.def.speed.toFixed(1)}ly/s`,
        `STATUS: ${creature.def.fearful ? 'EVASIVE' : 'STABLE'}`,
        `ORIGIN: SECTOR ${worldState.cfg.name.toUpperCase()}`
      ] : [
        `BIOME: ${worldState.cfg.biome.toUpperCase()}`,
        `TOTAL BIOMASS: ${worldState.continents.reduce((acc, cont) => acc + cont.creatures.reduce((a, c) => a + c.count, 0), 0)} UNITS`,
        `CONTINENTS: ${worldState.continents.length}`,
        `ATMOSPHERE: STABLE`,
        `PLANET: ${worldState.cfg.name.toUpperCase()}`
      ];
    stats.forEach((text, i) => ctx.fillText(text, 40, 355 + (i * 25)));

    // 4. MISSION LOGS
    const logStartY = 490;
    ctx.fillStyle = 'rgba(80, 160, 255, 0.2)';
    ctx.fillRect(25, logStartY, w - 50, 1);
    ctx.fillStyle = '#3a9fff';
    ctx.font = "bold 11px 'Space Mono', monospace";
    ctx.fillText("MISSION LOGS // RECENT ACTIVITY", 25, logStartY + 25);

    if (typeof interactionEntries !== 'undefined' && interactionEntries.length > 0) {
      interactionEntries.slice(-8).forEach((entry, i) => {
        const cleanMsg = entry.text.replace(/<[^>]*>?/gm, '');
        ctx.fillStyle = 'rgba(200, 216, 238, 0.6)';
        ctx.fillText(`> ${cleanMsg.substring(0, 65)}`, 35, logStartY + 55 + (i * 22));
      });
    }

    // 5. FOOTER & WEBSITE UPLINK (The change is here)
    ctx.fillStyle = 'rgba(123, 95, 255, 0.2)';
    ctx.fillRect(10, h - 60, w - 20, 50); // Bottom bar

    ctx.globalAlpha = 1.0;
    ctx.fillStyle = '#7b5fff';
    ctx.font = "bold 11px 'Space Mono', monospace";
    ctx.fillText("SOURCE UPLINK:", 25, h - 30);
    
    ctx.fillStyle = '#fff';
    ctx.font = "11px 'Space Mono', monospace";
    // Your website URL
    ctx.fillText("https://coyoteke.com/GameEngineForPlanets/genWorld.html", 130, h - 30);

    // 6. SAVE
    canvas.toBlob(blob => {
      const fileName = creature ? `specimen_${creature.def.id}.png` : `ecosystem_${worldState.cfg.name}.png`;
      const link = document.createElement('a');
      link.download = fileName;
      link.href = canvas.toDataURL('image/png');
      link.click();

      btn.innerHTML = originalText;
      btn.style.opacity = "1";
      btn.style.pointerEvents = "auto";
    }, 'image/png');
  };

  sceneImg.src = url;
}
</script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QFREM81DZ4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-QFREM81DZ4');
  </script>
</body>
</html>
